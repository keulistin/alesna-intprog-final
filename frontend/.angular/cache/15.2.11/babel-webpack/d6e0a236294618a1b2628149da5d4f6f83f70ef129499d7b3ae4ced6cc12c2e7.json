{"ast":null,"code":"import { HttpResponse, HTTP_INTERCEPTORS, HttpErrorResponse } from '@angular/common/http';\nimport { of, throwError } from 'rxjs';\nimport { delay, mergeMap, materialize, dematerialize } from 'rxjs/operators';\nimport { Role } from '@app/_models'; // Assuming this path is correct\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@app/_services\";\n// Key for localStorage\nconst accountsKey = 'app-hr-tool-accounts'; // Made key more specific\nexport let FakeBackendInterceptor = /*#__PURE__*/(() => {\n  class FakeBackendInterceptor {\n    constructor(alertService) {\n      this.alertService = alertService;\n      // In-memory for other entities\n      this.employees = [{\n        id: 1,\n        employeeId: 'EMP001',\n        userId: 1,\n        email: 'admin@example.com',\n        position: 'Developer',\n        departmentId: 1,\n        hireDate: '2025-01-01',\n        status: 'Active'\n      }, {\n        id: 2,\n        employeeId: 'EMP002',\n        userId: 2,\n        email: 'user@example.com',\n        position: 'Designer',\n        departmentId: 2,\n        hireDate: '2025-02-01',\n        status: 'Active'\n      }];\n      this.departments = [{\n        id: 1,\n        name: 'Engineering',\n        description: 'Software development team',\n        employeeCount: 1\n      }, {\n        id: 2,\n        name: 'Marketing',\n        description: 'Marketing team',\n        employeeCount: 1\n      }];\n      this.workflows = [{\n        id: 1,\n        employeeId: 1,\n        type: 'Onboarding',\n        details: {\n          task: 'Setup workstation'\n        },\n        status: 'Pending',\n        datetimecreated: new Date(Date.now() - 100000).toISOString()\n      }, {\n        id: 2,\n        employeeId: 2,\n        type: 'Offboarding',\n        details: {\n          task: 'Return equipment'\n        },\n        status: 'Completed',\n        datetimecreated: new Date(Date.now() - 200000).toISOString()\n      }];\n      this.appRequests = [{\n        id: 1,\n        employeeId: 2,\n        type: 'Equipment',\n        requestItems: [{\n          name: 'Laptop',\n          quantity: 1\n        }],\n        status: 'Pending'\n      }];\n      // ID Generators for in-memory entities\n      this.nextEmployeeId = this.employees.length > 0 ? Math.max(0, ...this.employees.map(e => e.id)) + 1 : 1;\n      this.nextDepartmentId = this.departments.length > 0 ? Math.max(0, ...this.departments.map(d => d.id)) + 1 : 1;\n      this.nextWorkflowId = this.workflows.length > 0 ? Math.max(0, ...this.workflows.map(w => w.id)) + 1 : 1;\n      this.nextAppRequestId = this.appRequests.length > 0 ? Math.max(0, ...this.appRequests.map(r => r.id)) + 1 : 1;\n      this.accounts = JSON.parse(localStorage.getItem(accountsKey)) || [];\n      // Ensure default admin/user if local storage is empty or new\n      if (this.accounts.length === 0) {\n        this.accounts.push({\n          id: 1,\n          title: 'Mr',\n          email: 'admin@example.com',\n          password: 'admin',\n          role: Role.Admin,\n          employeeId: 1,\n          isVerified: true,\n          status: 'Active',\n          refreshTokens: [],\n          dateCreated: new Date().toISOString(),\n          firstName: 'Admin',\n          lastName: 'User'\n        });\n        this.accounts.push({\n          id: 2,\n          title: 'Mr',\n          email: 'user@example.com',\n          password: 'user',\n          role: Role.User,\n          employeeId: 2,\n          isVerified: true,\n          status: 'Active',\n          refreshTokens: [],\n          dateCreated: new Date().toISOString(),\n          firstName: 'Normal',\n          lastName: 'User'\n        });\n        this.saveAccounts();\n      }\n    }\n    intercept(request, next) {\n      const {\n        url,\n        method,\n        headers,\n        body\n      } = request;\n      return of(null).pipe(mergeMap(() => this.handleRoute(url, method, headers, body, next))).pipe(materialize()).pipe(delay(500)).pipe(dematerialize());\n    }\n    handleRoute(url, method, headers, body, next) {\n      // --- ACCOUNT MANAGEMENT ROUTES ---\n      switch (true) {\n        case url.endsWith('/accounts/authenticate') && method === 'POST':\n          return this.authenticate(body, headers);\n        case url.endsWith('/accounts/refresh-token') && method === 'POST':\n          return this.refreshToken(body, headers);\n        case url.endsWith('/accounts/revoke-token') && method === 'POST':\n          return this.revokeToken(body, headers);\n        case url.endsWith('/accounts/register') && method === 'POST':\n          return this.register(body);\n        case url.endsWith('/accounts/verify-email') && method === 'POST':\n          return this.verifyEmail(body);\n        case url.endsWith('/accounts/forgot-password') && method === 'POST':\n          return this.forgotPassword(body);\n        case url.endsWith('/accounts/validate-reset-token') && method === 'POST':\n          return this.validateResetToken(body);\n        case url.endsWith('/accounts/reset-password') && method === 'POST':\n          return this.resetPassword(body);\n        case url.endsWith('/accounts') && method === 'GET':\n          return this.getAccounts(headers);\n        case url.match(/\\/accounts\\/(\\d+)$/) && method === 'GET':\n          return this.getAccountById(this.idFromUrl(url), headers);\n        case url.endsWith('/accounts') && method === 'POST':\n          return this.createAccount(body, headers);\n        case url.match(/\\/accounts\\/(\\d+)$/) && method === 'PUT':\n          return this.updateAccount(this.idFromUrl(url), body, headers);\n        case url.match(/\\/accounts\\/(\\d+)$/) && method === 'DELETE':\n          return this.deleteAccount(this.idFromUrl(url), headers);\n        // --- OTHER ENTITY ROUTES ---\n        // Employees\n        case url.endsWith('/employees') && method === 'GET':\n          return this.authorize(headers, null, () => this.ok(this.employees));\n        case url.endsWith('/employees') && method === 'POST':\n          return this.authorize(headers, Role.Admin, () => {\n            const newEmployee = Object.assign({\n              id: this.nextEmployeeId++\n            }, body);\n            this.employees.push(newEmployee);\n            const dept = this.departments.find(d => d.id === newEmployee.departmentId);\n            if (dept) dept.employeeCount++;\n            return this.ok(newEmployee, 201);\n          });\n        case url.match(/\\/employees\\/(\\d+)$/) && method === 'GET':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, null, () => {\n              const employee = this.employees.find(e => e.id === id);\n              return employee ? this.ok(employee) : this.error('Employee not found', 404);\n            });\n          }\n        case url.match(/\\/employees\\/(\\d+)$/) && method === 'PUT':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, Role.Admin, () => {\n              const employeeIndex = this.employees.findIndex(e => e.id === id);\n              if (employeeIndex === -1) return this.error('Employee not found', 404);\n              const oldEmployeeData = this.employees[employeeIndex];\n              const updatedEmployee = Object.assign(Object.assign(Object.assign({}, oldEmployeeData), body), {\n                id\n              });\n              if (oldEmployeeData.departmentId !== updatedEmployee.departmentId) {\n                const oldDept = this.departments.find(d => d.id === oldEmployeeData.departmentId);\n                if (oldDept) oldDept.employeeCount = Math.max(0, oldDept.employeeCount - 1);\n                const newDept = this.departments.find(d => d.id === updatedEmployee.departmentId);\n                if (newDept) newDept.employeeCount++;else return this.error('Target department not found', 400);\n              }\n              this.employees[employeeIndex] = updatedEmployee;\n              return this.ok(this.employees[employeeIndex]);\n            });\n          }\n        case url.match(/\\/employees\\/(\\d+)$/) && method === 'DELETE':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, Role.Admin, () => {\n              const employeeIndex = this.employees.findIndex(e => e.id === id);\n              if (employeeIndex === -1) return this.error('Employee not found', 404);\n              const deletedEmployee = this.employees.splice(employeeIndex, 1)[0];\n              if (deletedEmployee) {\n                const dept = this.departments.find(d => d.id === deletedEmployee.departmentId);\n                if (dept) dept.employeeCount = Math.max(0, dept.employeeCount - 1);\n              }\n              return this.ok({\n                message: 'Employee deleted'\n              });\n            });\n          }\n        case url.match(/\\/employees\\/(\\d+)\\/transfer$/) && method === 'POST':\n          {\n            const idMatch = url.match(/\\/employees\\/(\\d+)\\/transfer$/);\n            if (!idMatch) return this.error('Invalid URL for employee transfer', 400);\n            const id = parseInt(idMatch[1]);\n            return this.authorize(headers, Role.Admin, () => {\n              const employee = this.employees.find(e => e.id === id);\n              if (!employee) return this.error('Employee not found', 404);\n              const oldDepartmentId = employee.departmentId;\n              const newDepartmentId = body.departmentId;\n              if (oldDepartmentId !== newDepartmentId) {\n                const oldDept = this.departments.find(d => d.id === oldDepartmentId);\n                if (oldDept) oldDept.employeeCount = Math.max(0, oldDept.employeeCount - 1);\n                const newDept = this.departments.find(d => d.id === newDepartmentId);\n                if (newDept) newDept.employeeCount++;else return this.error('Target department not found', 400);\n              }\n              employee.departmentId = newDepartmentId;\n              this.workflows.push({\n                id: this.nextWorkflowId++,\n                employeeId: id,\n                type: 'Transfer',\n                details: body,\n                status: 'Pending',\n                datetimecreated: new Date().toISOString()\n              });\n              return this.ok({\n                message: 'Employee transferred successfully',\n                employee\n              });\n            });\n          }\n        // Departments\n        case url.endsWith('/departments') && method === 'GET':\n          return this.authorize(headers, null, () => this.ok(this.departments));\n        case url.endsWith('/departments') && method === 'POST':\n          return this.authorize(headers, Role.Admin, () => {\n            const newDepartment = Object.assign(Object.assign({\n              id: this.nextDepartmentId++\n            }, body), {\n              employeeCount: 0\n            });\n            this.departments.push(newDepartment);\n            return this.ok(newDepartment, 201);\n          });\n        case url.match(/\\/departments\\/(\\d+)$/) && method === 'GET':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, null, () => {\n              const department = this.departments.find(d => d.id === id);\n              return department ? this.ok(department) : this.error(`Department with id ${id} not found`, 404);\n            });\n          }\n        case url.match(/\\/departments\\/(\\d+)$/) && method === 'PUT':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, Role.Admin, () => {\n              const deptIndex = this.departments.findIndex(d => d.id === id);\n              if (deptIndex === -1) return this.error('Department not found', 404);\n              this.departments[deptIndex] = Object.assign(Object.assign(Object.assign({}, this.departments[deptIndex]), body), {\n                id\n              });\n              return this.ok(this.departments[deptIndex]);\n            });\n          }\n        case url.match(/\\/departments\\/(\\d+)$/) && method === 'DELETE':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, Role.Admin, () => {\n              const dept = this.departments.find(d => d.id === id);\n              if (!dept) return this.error('Department not found', 404);\n              if (dept.employeeCount > 0) return this.error('Cannot delete department with active employees.', 400);\n              this.departments = this.departments.filter(d => d.id !== id);\n              return this.ok({\n                message: 'Department deleted'\n              });\n            });\n          }\n        // Workflows\n        case url.match(/\\/workflows\\/employee\\/(\\d+)$/) && method === 'GET':\n          {\n            const idMatch = url.match(/\\/workflows\\/employee\\/(\\d+)$/);\n            if (!idMatch) return this.error('Invalid URL for employee workflows', 400);\n            const employeeId = parseInt(idMatch[1]);\n            return this.authorize(headers, null, () => {\n              const workflows = this.workflows.filter(w => w.employeeId === employeeId);\n              return this.ok(workflows);\n            });\n          }\n        case url.endsWith('/workflows') && method === 'POST':\n          return this.authorize(headers, Role.Admin, () => {\n            const newWorkflow = Object.assign(Object.assign({\n              id: this.nextWorkflowId++\n            }, body), {\n              datetimecreated: new Date().toISOString() // Add timestamp on creation\n            });\n\n            this.workflows.push(newWorkflow);\n            return this.ok(newWorkflow, 201);\n          });\n        // *** ADDED HANDLER FOR GET /workflows ***\n        case url.endsWith('/workflows') && method === 'GET':\n          return this.authorize(headers, Role.Admin, () => {\n            // Optional: sort workflows if not already handled by client or a specific query param\n            const sortedWorkflows = [...this.workflows].sort((a, b) => {\n              const dateA = new Date(a.datetimecreated || 0).getTime();\n              const dateB = new Date(b.datetimecreated || 0).getTime();\n              return dateB - dateA; // Descending\n            });\n\n            return this.ok(sortedWorkflows);\n          });\n        // AppRequests\n        case url.endsWith('/requests') && method === 'GET':\n          return this.authorize(headers, null, () => {\n            const currentAcc = this.currentAccount(headers);\n            if (!currentAcc) return this.unauthorized();\n            if (currentAcc.role === Role.Admin) return this.ok(this.appRequests);\n            const userRequests = this.appRequests.filter(r => {\n              const emp = this.employees.find(e => e.id === r.employeeId);\n              return emp && emp.userId === currentAcc.id;\n            });\n            return this.ok(userRequests);\n          });\n        case url.endsWith('/requests') && method === 'POST':\n          return this.authorize(headers, null, () => {\n            const currentAcc = this.currentAccount(headers);\n            if (!currentAcc || !currentAcc.employeeId) return this.error(\"User not linked to an employee or not authenticated.\", 400);\n            const newRequest = Object.assign(Object.assign({\n              id: this.nextAppRequestId++,\n              employeeId: currentAcc.employeeId\n            }, body), {\n              status: 'Pending'\n            });\n            this.appRequests.push(newRequest);\n            return this.ok(newRequest, 201);\n          });\n        case url.match(/\\/requests\\/(\\d+)$/) && method === 'GET':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, null, () => {\n              const currentAcc = this.currentAccount(headers);\n              if (!currentAcc) return this.unauthorized();\n              const request = this.appRequests.find(r => r.id === id);\n              if (!request) {\n                return this.error(`Request with id ${id} not found`, 404);\n              }\n              // Authorization check: Admin can see any, user can only see their own\n              if (currentAcc.role !== Role.Admin) {\n                const employee = this.employees.find(e => e.id === request.employeeId);\n                if (!employee || employee.userId !== currentAcc.id) {\n                  return this.unauthorized(\"You are not authorized to view this request.\");\n                }\n              }\n              return this.ok(request);\n            });\n          }\n        default:\n          // return next.handle(request); // If you have a real backend\n          return throwError(() => new HttpErrorResponse({\n            status: 404,\n            error: {\n              message: `Fake backend: Route not found for ${method} ${url}`\n            }\n          }));\n      }\n    }\n    // --- ACCOUNT MANAGEMENT METHODS ---\n    authenticate(body, headers) {\n      const {\n        email,\n        password\n      } = body;\n      const account = this.accounts.find(x => x.email === email);\n      if (!account) return this.error('Email does not exist', 400);\n      if (!account.isVerified) {\n        setTimeout(() => {\n          const verifyUrl = `${location.origin}/account/verify-email?token=${account.verificationToken}`;\n          this.alertService.info(`<h4>Verification Email</h4><p>Please click the link to verify: <a href=\"${verifyUrl}\">${verifyUrl}</a></p>`, {\n            autoClose: false\n          });\n        }, 1000);\n        return this.error('Email is not yet verified. Please check your inbox.', 400);\n      }\n      if (account.password !== password) return this.error('Invalid email or password.', 400);\n      if (account.status !== 'Active') return this.error('Account is inactive. Please contact support.', 400);\n      account.refreshTokens = account.refreshTokens || [];\n      account.refreshTokens.push(this.generateRefreshTokenForCookie());\n      this.saveAccounts();\n      const accountDetails = this.basicDetails(account);\n      return this.ok(Object.assign(Object.assign({}, accountDetails), {\n        jwtToken: this.generateJwtToken(account)\n      }));\n    }\n    refreshToken(body, headers) {\n      const requestRefreshTokenFromBody = body.refreshToken;\n      const requestRefreshTokenFromCookie = this.getRefreshTokenFromCookie();\n      const requestRefreshToken = requestRefreshTokenFromBody || requestRefreshTokenFromCookie;\n      if (!requestRefreshToken) return this.unauthorized('Refresh token missing.');\n      const account = this.accounts.find(x => x.refreshTokens && x.refreshTokens.includes(requestRefreshToken));\n      if (!account) return this.unauthorized('Invalid or expired refresh token.');\n      account.refreshTokens = account.refreshTokens.filter(x => x !== requestRefreshToken);\n      account.refreshTokens.push(this.generateRefreshTokenForCookie());\n      this.saveAccounts();\n      return this.ok(Object.assign(Object.assign({}, this.basicDetails(account)), {\n        jwtToken: this.generateJwtToken(account)\n      }));\n    }\n    revokeToken(body, headers) {\n      const currentAcc = this.currentAccount(headers);\n      if (!currentAcc) return this.unauthorized();\n      const tokenToRevoke = body.token || this.getRefreshTokenFromCookie();\n      const account = this.accounts.find(x => x.id === currentAcc.id);\n      if (account && account.refreshTokens && tokenToRevoke) {\n        account.refreshTokens = account.refreshTokens.filter(x => x !== tokenToRevoke);\n        this.saveAccounts();\n      }\n      if (tokenToRevoke && tokenToRevoke === this.getRefreshTokenFromCookie()) {\n        this.clearRefreshTokenCookie();\n      }\n      return this.ok({\n        message: 'Token revoked successfully.'\n      });\n    }\n    register(body) {\n      const newAccountData = body;\n      if (!newAccountData.email || !newAccountData.password) {\n        return this.error('Email and password are required.', 400);\n      }\n      if (this.accounts.find(x => x.email === newAccountData.email)) {\n        setTimeout(() => this.alertService.error(`Email '${newAccountData.email}' is already registered.`), 1000);\n        return this.error(`Email '${newAccountData.email}' is already registered.`, 400);\n      }\n      const newAccount = {\n        id: this.newAccountId(),\n        email: newAccountData.email,\n        password: newAccountData.password,\n        role: this.accounts.length === 0 ? Role.Admin : Role.User,\n        firstName: newAccountData.firstName || '',\n        lastName: newAccountData.lastName || '',\n        title: newAccountData.title || '',\n        status: this.accounts.length === 0 ? 'Active' : 'Inactive',\n        dateCreated: new Date().toISOString(),\n        verificationToken: `${Date.now()}-${Math.random().toString(36).substring(2, 10)}`,\n        isVerified: this.accounts.length === 0,\n        refreshTokens: []\n      };\n      this.accounts.push(newAccount);\n      this.saveAccounts();\n      if (!newAccount.isVerified) {\n        setTimeout(() => {\n          const verifyUrl = `${location.origin}/account/verify-email?token=${newAccount.verificationToken}`;\n          this.alertService.info(`<h4>Verification Email</h4><p>Thanks for registering! Please click the link to verify your email: <a href=\"${verifyUrl}\">${verifyUrl}</a></p><div><strong>NOTE:</strong> This is a fake email.</div>`, {\n            autoClose: false\n          });\n        }, 1000);\n      }\n      return this.ok({\n        message: 'Registration successful. Please check your email to verify your account if required.'\n      }, 201);\n    }\n    verifyEmail(body) {\n      const {\n        token\n      } = body;\n      if (!token) return this.error('Verification token is required.', 400);\n      const account = this.accounts.find(x => x.verificationToken === token);\n      if (!account) return this.error('Verification failed. Invalid or expired token.', 400);\n      if (account.isVerified) return this.ok({\n        message: 'Email already verified.'\n      });\n      account.isVerified = true;\n      account.status = 'Active';\n      delete account.verificationToken;\n      this.saveAccounts();\n      return this.ok({\n        message: 'Email verified successfully. You can now login.'\n      });\n    }\n    forgotPassword(body) {\n      const {\n        email\n      } = body;\n      if (!email) return this.error('Email is required.', 400);\n      const account = this.accounts.find(x => x.email === email);\n      if (account) {\n        account.resetToken = `${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;\n        account.resetTokenExpires = new Date(Date.now() + 24 * 60 * 60 * 1000);\n        this.saveAccounts();\n        setTimeout(() => {\n          const resetUrl = `${location.origin}/account/reset-password?token=${account.resetToken}`;\n          this.alertService.info(`<h4>Reset Password Email</h4><p>Please click the link to reset your password: <a href=\"${resetUrl}\">${resetUrl}</a></p><p>The link will be valid for 24 hours.</p><div><strong>NOTE:</strong> This is a fake email.</div>`, {\n            autoClose: false\n          });\n        }, 1000);\n      }\n      return this.ok({\n        message: 'If your email address is registered, you will receive a password reset link.'\n      });\n    }\n    validateResetToken(body) {\n      const {\n        token\n      } = body;\n      if (!token) return this.error('Reset token is required.', 400);\n      const account = this.accounts.find(x => x.resetToken === token && x.resetTokenExpires && new Date(x.resetTokenExpires) > new Date());\n      return account ? this.ok({\n        message: 'Token is valid.'\n      }) : this.error('Invalid or expired reset token.', 400);\n    }\n    resetPassword(body) {\n      const {\n        token,\n        password\n      } = body;\n      if (!token || !password) return this.error('Token and new password are required.', 400);\n      const account = this.accounts.find(x => x.resetToken === token && x.resetTokenExpires && new Date(x.resetTokenExpires) > new Date());\n      if (!account) return this.error('Invalid or expired reset token.', 400);\n      account.password = password;\n      account.isVerified = true;\n      account.status = 'Active';\n      delete account.resetToken;\n      delete account.resetTokenExpires;\n      this.saveAccounts();\n      return this.ok({\n        message: 'Password has been reset successfully. You can now login.'\n      });\n    }\n    getAccounts(headers) {\n      return this.authorize(headers, Role.Admin, () => {\n        return this.ok(this.accounts.map(acc => this.basicDetails(acc)));\n      });\n    }\n    getAccountById(id, headers) {\n      const currentAcc = this.currentAccount(headers);\n      if (!currentAcc) return this.unauthorized();\n      const account = this.accounts.find(x => x.id === id);\n      if (!account) return this.error('Account not found', 404);\n      if (currentAcc.role !== Role.Admin && currentAcc.id !== account.id) {\n        return this.unauthorized(\"You are not authorized to view this account.\");\n      }\n      return this.ok(this.basicDetails(account));\n    }\n    createAccount(body, headers) {\n      return this.authorize(headers, Role.Admin, () => {\n        const newAccountData = body;\n        if (!newAccountData.email || !newAccountData.password || !newAccountData.role) {\n          return this.error('Email, password, and role are required for new account creation.', 400);\n        }\n        if (this.accounts.find(x => x.email === newAccountData.email)) {\n          return this.error(`Email '${newAccountData.email}' is already registered`, 400);\n        }\n        const newAccount = {\n          id: this.newAccountId(),\n          email: newAccountData.email,\n          password: newAccountData.password,\n          role: newAccountData.role,\n          firstName: newAccountData.firstName || '',\n          lastName: newAccountData.lastName || '',\n          title: newAccountData.title || '',\n          dateCreated: new Date().toISOString(),\n          isVerified: true,\n          status: 'Active',\n          refreshTokens: [],\n          employeeId: newAccountData.employeeId\n        };\n        this.accounts.push(newAccount);\n        this.saveAccounts();\n        return this.ok(this.basicDetails(newAccount), 201);\n      });\n    }\n    updateAccount(id, body, headers) {\n      const currentAcc = this.currentAccount(headers);\n      if (!currentAcc) return this.unauthorized();\n      const accountIndex = this.accounts.findIndex(x => x.id === id);\n      if (accountIndex === -1) return this.error('Account not found', 404);\n      const accountToUpdate = this.accounts[accountIndex];\n      if (currentAcc.role !== Role.Admin && currentAcc.id !== accountToUpdate.id) {\n        return this.unauthorized(\"You are not authorized to update this account.\");\n      }\n      const updateData = Object.assign({}, body);\n      if (currentAcc.id === accountToUpdate.id && currentAcc.role !== Role.Admin && updateData.role && updateData.role !== accountToUpdate.role) {\n        return this.error(\"You cannot change your own role.\", 403);\n      }\n      if (updateData.password) {\n        accountToUpdate.password = updateData.password;\n      }\n      ['firstName', 'lastName', 'title', 'email', 'role', 'status', 'employeeId'].forEach(field => {\n        if (updateData[field] !== undefined) {\n          accountToUpdate[field] = updateData[field];\n        }\n      });\n      accountToUpdate.dateUpdated = new Date().toISOString();\n      this.accounts[accountIndex] = accountToUpdate;\n      this.saveAccounts();\n      return this.ok(this.basicDetails(accountToUpdate));\n    }\n    deleteAccount(id, headers) {\n      const currentAcc = this.currentAccount(headers);\n      if (!currentAcc) return this.unauthorized();\n      const accountIndex = this.accounts.findIndex(x => x.id === id);\n      if (accountIndex === -1) return this.error('Account not found', 404);\n      const accountToDelete = this.accounts[accountIndex];\n      if (currentAcc.role !== Role.Admin && currentAcc.id !== accountToDelete.id) {\n        return this.unauthorized(\"You are not authorized to delete this account.\");\n      }\n      if (accountToDelete.id === currentAcc.id && accountToDelete.role === Role.Admin && this.accounts.filter(a => a.role === Role.Admin).length <= 1) {\n        return this.error(\"Cannot delete the last admin account.\", 400);\n      }\n      this.accounts.splice(accountIndex, 1);\n      this.saveAccounts();\n      if (accountToDelete.id === currentAcc.id) {\n        this.clearRefreshTokenCookie();\n      }\n      return this.ok({\n        message: 'Account deleted successfully.'\n      });\n    }\n    // --- HELPER METHODS ---\n    ok(body, status = 200) {\n      return of(new HttpResponse({\n        status,\n        body\n      }));\n    }\n    error(message, status = 400) {\n      return throwError(() => new HttpErrorResponse({\n        error: {\n          message\n        },\n        status\n      }));\n    }\n    unauthorized(message = 'Unauthorized') {\n      return throwError(() => new HttpErrorResponse({\n        status: 401,\n        error: {\n          message\n        }\n      }));\n    }\n    basicDetails(account) {\n      const {\n        id,\n        title,\n        firstName,\n        lastName,\n        email,\n        role,\n        dateCreated,\n        dateUpdated,\n        isVerified,\n        status,\n        employeeId\n      } = account;\n      return {\n        id,\n        title,\n        firstName,\n        lastName,\n        email,\n        role,\n        dateCreated,\n        dateUpdated,\n        isVerified,\n        status,\n        employeeId\n      };\n    }\n    currentAccount(headers) {\n      const authHeader = headers.get('Authorization');\n      if (!authHeader || !authHeader.startsWith('Bearer ')) return undefined;\n      const token = authHeader.substring(7);\n      try {\n        const payloadB64 = token.split('.')[1];\n        if (!payloadB64) return undefined;\n        const tokenPayload = JSON.parse(atob(payloadB64));\n        if (Date.now() >= tokenPayload.exp * 1000) {\n          console.warn(\"Fake backend: JWT token expired\");\n          this.clearRefreshTokenCookie();\n          return undefined;\n        }\n        return this.accounts.find(x => x.id === tokenPayload.id);\n      } catch (e) {\n        console.error(\"Fake backend: Error parsing JWT token\", e);\n        return undefined;\n      }\n    }\n    authorize(headers, requiredRole, successCallback) {\n      const account = this.currentAccount(headers);\n      if (!account) {\n        return this.unauthorized('Missing or invalid authentication token.');\n      }\n      if (requiredRole && account.role !== requiredRole) {\n        return throwError(() => new HttpErrorResponse({\n          status: 403,\n          error: {\n            message: 'Forbidden - Insufficient permissions'\n          }\n        }));\n      }\n      return successCallback();\n    }\n    idFromUrl(url) {\n      const match = url.match(/\\/(\\d+)$/);\n      return match ? parseInt(match[1], 10) : -1;\n    }\n    newAccountId() {\n      return this.accounts.length ? Math.max(0, ...this.accounts.map(x => x.id)) + 1 : 1;\n    }\n    saveAccounts() {\n      localStorage.setItem(accountsKey, JSON.stringify(this.accounts));\n    }\n    generateJwtToken(account) {\n      const payload = {\n        id: account.id,\n        role: account.role,\n        email: account.email,\n        exp: Math.floor(new Date(Date.now() + 15 * 60 * 1000).getTime() / 1000)\n      };\n      const header = btoa(JSON.stringify({\n        alg: 'HS256',\n        typ: 'JWT'\n      }));\n      const encodedPayload = btoa(JSON.stringify(payload));\n      return `${header}.${encodedPayload}.fake-signature-for-demo-only`;\n    }\n    generateRefreshTokenForCookie() {\n      const token = `${Date.now()}-${Math.random().toString(36).substring(2, 12)}`;\n      const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toUTCString();\n      if (typeof document !== 'undefined') {\n        document.cookie = `fakeRefreshToken=${token}; expires=${expires}; path=/; SameSite=Lax`;\n      }\n      return token;\n    }\n    getRefreshTokenFromCookie() {\n      if (typeof document === 'undefined') return undefined;\n      const cookies = document.cookie.split(';');\n      for (let cookie of cookies) {\n        const [name, value] = cookie.trim().split('=');\n        if (name === 'fakeRefreshToken') {\n          return value;\n        }\n      }\n      return undefined;\n    }\n    clearRefreshTokenCookie() {\n      if (typeof document !== 'undefined') {\n        document.cookie = 'fakeRefreshToken=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax';\n      }\n    }\n  }\n  FakeBackendInterceptor.ɵfac = function FakeBackendInterceptor_Factory(t) {\n    return new (t || FakeBackendInterceptor)(i0.ɵɵinject(i1.AlertService));\n  };\n  FakeBackendInterceptor.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: FakeBackendInterceptor,\n    factory: FakeBackendInterceptor.ɵfac\n  });\n  return FakeBackendInterceptor;\n})();\nexport const fakeBackendProvider = {\n  provide: HTTP_INTERCEPTORS,\n  useClass: FakeBackendInterceptor,\n  multi: true\n};","map":{"version":3,"mappings":"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","names":["HttpResponse","HTTP_INTERCEPTORS","HttpErrorResponse","of","throwError","delay","mergeMap","materialize","dematerialize","Role","accountsKey","FakeBackendInterceptor","constructor","alertService","id","employeeId","userId","email","position","departmentId","hireDate","status","name","description","employeeCount","type","details","task","datetimecreated","Date","now","toISOString","requestItems","quantity","employees","length","Math","max","map","e","departments","d","workflows","w","appRequests","r","accounts","JSON","parse","localStorage","getItem","push","title","password","role","Admin","isVerified","refreshTokens","dateCreated","firstName","lastName","User","saveAccounts","intercept","request","next","url","method","headers","body","pipe","handleRoute","endsWith","authenticate","refreshToken","revokeToken","register","verifyEmail","forgotPassword","validateResetToken","resetPassword","getAccounts","match","getAccountById","idFromUrl","createAccount","updateAccount","deleteAccount","authorize","ok","newEmployee","nextEmployeeId","dept","find","employee","error","employeeIndex","findIndex","oldEmployeeData","updatedEmployee","oldDept","newDept","deletedEmployee","splice","message","idMatch","parseInt","oldDepartmentId","newDepartmentId","nextWorkflowId","newDepartment","nextDepartmentId","department","deptIndex","filter","newWorkflow","sortedWorkflows","sort","a","b","dateA","getTime","dateB","currentAcc","currentAccount","unauthorized","userRequests","emp","newRequest","nextAppRequestId","account","x","setTimeout","verifyUrl","location","origin","verificationToken","info","autoClose","generateRefreshTokenForCookie","accountDetails","basicDetails","jwtToken","generateJwtToken","requestRefreshTokenFromBody","requestRefreshTokenFromCookie","getRefreshTokenFromCookie","requestRefreshToken","includes","tokenToRevoke","token","clearRefreshTokenCookie","newAccountData","newAccount","newAccountId","random","toString","substring","resetToken","resetTokenExpires","resetUrl","acc","accountIndex","accountToUpdate","updateData","Object","forEach","field","undefined","dateUpdated","accountToDelete","authHeader","get","startsWith","payloadB64","split","tokenPayload","atob","exp","console","warn","requiredRole","successCallback","setItem","stringify","payload","floor","header","btoa","alg","typ","encodedPayload","expires","toUTCString","document","cookie","cookies","value","trim","factory","fakeBackendProvider","provide","useClass","multi"],"sourceRoot":"","sources":["E:\\semifinals\\groupB-fullstack-app\\frontend\\src\\app\\_helpers\\fake-backend.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\r\nimport {\r\n    HttpRequest,\r\n    HttpResponse,\r\n    HttpHandler,\r\n    HttpEvent,\r\n    HttpInterceptor,\r\n    HTTP_INTERCEPTORS,\r\n    HttpErrorResponse,\r\n    HttpHeaders\r\n} from '@angular/common/http';\r\nimport { Observable, of, throwError } from 'rxjs';\r\nimport { delay, mergeMap, materialize, dematerialize } from 'rxjs/operators';\r\n\r\nimport { AlertService } from '@app/_services'; // Assuming this path is correct\r\nimport { Role } from '@app/_models';        // Assuming this path is correct\r\n\r\n// --- Interfaces - Combining and refining ---\r\ninterface Account {\r\n    id: number;\r\n    title: string;\r\n    firstName?: string;\r\n    lastName?: string;\r\n    email: string;\r\n    password?: string; // Should be hashed in a real app, stored as-is for fake backend comparison\r\n    role: Role | string;\r\n    employeeId?: number; // Link to an employee\r\n    jwtToken?: string; // For the access token (typically not stored with user, but for response)\r\n    dateCreated?: string;\r\n    dateUpdated?: string;\r\n    isVerified?: boolean;\r\n    verificationToken?: string;\r\n    resetToken?: string;\r\n    resetTokenExpires?: Date | string; // Store as ISO string or Date object\r\n    refreshTokens?: string[]; // Array of active refresh tokens\r\n    status?: 'Active' | 'Inactive' | string;\r\n}\r\n\r\ninterface Employee {\r\n    id: number;\r\n    employeeId: string; // The 'EMP001' style ID\r\n    userId: number; // This should link to Account.id\r\n    email: string; // Optional: If you want to link email to employee\r\n    position: string;\r\n    departmentId: number;\r\n    hireDate: string;\r\n    status: string;\r\n}\r\n\r\ninterface Department {\r\n    id: number;\r\n    name: string;\r\n    description: string;\r\n    employeeCount: number;\r\n}\r\n\r\ninterface Workflow {\r\n    id: number;\r\n    employeeId: number;\r\n    type: string;\r\n    details: any;\r\n    status: string;\r\n    // Optional: Add a creation timestamp if you want to sort by it\r\n    datetimecreated?: string; // Example from a previous context if needed for sorting\r\n}\r\n\r\ninterface AppRequest { // Renamed from 'RequestItem' to avoid conflict with HttpRequest\r\n    id: number;\r\n    employeeId: number;\r\n    type: string;\r\n    requestItems: { name: string; quantity: number }[];\r\n    status: string;\r\n}\r\n\r\n// Key for localStorage\r\nconst accountsKey = 'app-hr-tool-accounts'; // Made key more specific\r\n\r\n@Injectable()\r\nexport class FakeBackendInterceptor implements HttpInterceptor {\r\n    // --- Data Management ---\r\n    private accounts: Account[];\r\n\r\n    // In-memory for other entities\r\n    private employees: Employee[] = [\r\n        { id: 1, employeeId: 'EMP001', userId: 1, email: 'admin@example.com', position: 'Developer', departmentId: 1, hireDate: '2025-01-01', status: 'Active' },\r\n        { id: 2, employeeId: 'EMP002', userId: 2, email: 'user@example.com', position: 'Designer', departmentId: 2, hireDate: '2025-02-01', status: 'Active' }\r\n    ];\r\n    private departments: Department[] = [\r\n        { id: 1, name: 'Engineering', description: 'Software development team', employeeCount: 1 },\r\n        { id: 2, name: 'Marketing', description: 'Marketing team', employeeCount: 1 }\r\n    ];\r\n    private workflows: Workflow[] = [\r\n        { id: 1, employeeId: 1, type: 'Onboarding', details: { task: 'Setup workstation' }, status: 'Pending', datetimecreated: new Date(Date.now() - 100000).toISOString() },\r\n        { id: 2, employeeId: 2, type: 'Offboarding', details: { task: 'Return equipment' }, status: 'Completed', datetimecreated: new Date(Date.now() - 200000).toISOString() }\r\n    ];\r\n    private appRequests: AppRequest[] = [\r\n        { id: 1, employeeId: 2, type: 'Equipment', requestItems: [{ name: 'Laptop', quantity: 1 }], status: 'Pending' }\r\n    ];\r\n\r\n    // ID Generators for in-memory entities\r\n    private nextEmployeeId = this.employees.length > 0 ? Math.max(0, ...this.employees.map(e => e.id)) + 1 : 1;\r\n    private nextDepartmentId = this.departments.length > 0 ? Math.max(0, ...this.departments.map(d => d.id)) + 1 : 1;\r\n    private nextWorkflowId = this.workflows.length > 0 ? Math.max(0, ...this.workflows.map(w => w.id)) + 1 : 1;\r\n    private nextAppRequestId = this.appRequests.length > 0 ? Math.max(0, ...this.appRequests.map(r => r.id)) + 1 : 1;\r\n\r\n    constructor(private alertService: AlertService) {\r\n        this.accounts = JSON.parse(localStorage.getItem(accountsKey)) || [];\r\n        // Ensure default admin/user if local storage is empty or new\r\n        if (this.accounts.length === 0) {\r\n            this.accounts.push({\r\n                id: 1, title: 'Mr', email: 'admin@example.com', password: 'admin', role: Role.Admin, employeeId: 1,\r\n                isVerified: true, status: 'Active', refreshTokens: [], dateCreated: new Date().toISOString(),\r\n                firstName: 'Admin', lastName: 'User'\r\n            });\r\n            this.accounts.push({\r\n                id: 2, title: 'Mr', email: 'user@example.com', password: 'user', role: Role.User, employeeId: 2,\r\n                isVerified: true, status: 'Active', refreshTokens: [], dateCreated: new Date().toISOString(),\r\n                firstName: 'Normal', lastName: 'User'\r\n            });\r\n            this.saveAccounts();\r\n        }\r\n    }\r\n\r\n    intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\r\n        const { url, method, headers, body } = request;\r\n\r\n        return of(null)\r\n            .pipe(mergeMap(() => this.handleRoute(url, method, headers as HttpHeaders, body, next)))\r\n            .pipe(materialize())\r\n            .pipe(delay(500))\r\n            .pipe(dematerialize());\r\n    }\r\n\r\n    private handleRoute(url: string, method: string, headers: HttpHeaders, body: any, next: HttpHandler): Observable<HttpEvent<any>> {\r\n        // --- ACCOUNT MANAGEMENT ROUTES ---\r\n        switch (true) {\r\n            case url.endsWith('/accounts/authenticate') && method === 'POST':\r\n                return this.authenticate(body, headers);\r\n            case url.endsWith('/accounts/refresh-token') && method === 'POST':\r\n                return this.refreshToken(body, headers);\r\n            case url.endsWith('/accounts/revoke-token') && method === 'POST':\r\n                return this.revokeToken(body, headers);\r\n            case url.endsWith('/accounts/register') && method === 'POST':\r\n                return this.register(body);\r\n            case url.endsWith('/accounts/verify-email') && method === 'POST':\r\n                return this.verifyEmail(body);\r\n            case url.endsWith('/accounts/forgot-password') && method === 'POST':\r\n                return this.forgotPassword(body);\r\n            case url.endsWith('/accounts/validate-reset-token') && method === 'POST':\r\n                return this.validateResetToken(body);\r\n            case url.endsWith('/accounts/reset-password') && method === 'POST':\r\n                return this.resetPassword(body);\r\n            case url.endsWith('/accounts') && method === 'GET':\r\n                return this.getAccounts(headers);\r\n            case url.match(/\\/accounts\\/(\\d+)$/) && method === 'GET':\r\n                return this.getAccountById(this.idFromUrl(url), headers);\r\n            case url.endsWith('/accounts') && method === 'POST':\r\n                return this.createAccount(body, headers);\r\n            case url.match(/\\/accounts\\/(\\d+)$/) && method === 'PUT':\r\n                return this.updateAccount(this.idFromUrl(url), body, headers);\r\n            case url.match(/\\/accounts\\/(\\d+)$/) && method === 'DELETE':\r\n                return this.deleteAccount(this.idFromUrl(url), headers);\r\n\r\n            // --- OTHER ENTITY ROUTES ---\r\n            // Employees\r\n            case url.endsWith('/employees') && method === 'GET':\r\n                return this.authorize(headers, null, () => this.ok(this.employees));\r\n            case url.endsWith('/employees') && method === 'POST':\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const newEmployee: Employee = { id: this.nextEmployeeId++, ...body };\r\n                    this.employees.push(newEmployee);\r\n                    const dept = this.departments.find(d => d.id === newEmployee.departmentId);\r\n                    if (dept) dept.employeeCount++;\r\n                    return this.ok(newEmployee, 201);\r\n                });\r\n            case url.match(/\\/employees\\/(\\d+)$/) && method === 'GET': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, null, () => {\r\n                    const employee = this.employees.find(e => e.id === id);\r\n                    return employee ? this.ok(employee) : this.error('Employee not found', 404);\r\n                });\r\n            }\r\n            case url.match(/\\/employees\\/(\\d+)$/) && method === 'PUT': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const employeeIndex = this.employees.findIndex(e => e.id === id);\r\n                    if (employeeIndex === -1) return this.error('Employee not found', 404);\r\n                    const oldEmployeeData = this.employees[employeeIndex];\r\n                    const updatedEmployee = { ...oldEmployeeData, ...body, id };\r\n                    if (oldEmployeeData.departmentId !== updatedEmployee.departmentId) {\r\n                        const oldDept = this.departments.find(d => d.id === oldEmployeeData.departmentId);\r\n                        if (oldDept) oldDept.employeeCount = Math.max(0, oldDept.employeeCount - 1);\r\n                        const newDept = this.departments.find(d => d.id === updatedEmployee.departmentId);\r\n                        if (newDept) newDept.employeeCount++;\r\n                        else return this.error('Target department not found', 400);\r\n                    }\r\n                    this.employees[employeeIndex] = updatedEmployee;\r\n                    return this.ok(this.employees[employeeIndex]);\r\n                });\r\n            }\r\n            case url.match(/\\/employees\\/(\\d+)$/) && method === 'DELETE': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const employeeIndex = this.employees.findIndex(e => e.id === id);\r\n                    if (employeeIndex === -1) return this.error('Employee not found', 404);\r\n                    const deletedEmployee = this.employees.splice(employeeIndex, 1)[0];\r\n                    if (deletedEmployee) {\r\n                        const dept = this.departments.find(d => d.id === deletedEmployee.departmentId);\r\n                        if (dept) dept.employeeCount = Math.max(0, dept.employeeCount - 1);\r\n                    }\r\n                    return this.ok({ message: 'Employee deleted' });\r\n                });\r\n            }\r\n            case url.match(/\\/employees\\/(\\d+)\\/transfer$/) && method === 'POST': {\r\n                const idMatch = url.match(/\\/employees\\/(\\d+)\\/transfer$/);\r\n                if (!idMatch) return this.error('Invalid URL for employee transfer', 400);\r\n                const id = parseInt(idMatch[1]);\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const employee = this.employees.find(e => e.id === id);\r\n                    if (!employee) return this.error('Employee not found', 404);\r\n                    const oldDepartmentId = employee.departmentId;\r\n                    const newDepartmentId = body.departmentId;\r\n                    if (oldDepartmentId !== newDepartmentId) {\r\n                        const oldDept = this.departments.find(d => d.id === oldDepartmentId);\r\n                        if (oldDept) oldDept.employeeCount = Math.max(0, oldDept.employeeCount - 1);\r\n                        const newDept = this.departments.find(d => d.id === newDepartmentId);\r\n                        if (newDept) newDept.employeeCount++;\r\n                        else return this.error('Target department not found', 400);\r\n                    }\r\n                    employee.departmentId = newDepartmentId;\r\n                    this.workflows.push({\r\n                        id: this.nextWorkflowId++, employeeId: id, type: 'Transfer',\r\n                        details: body, status: 'Pending', datetimecreated: new Date().toISOString()\r\n                    });\r\n                    return this.ok({ message: 'Employee transferred successfully', employee });\r\n                });\r\n            }\r\n\r\n            // Departments\r\n            case url.endsWith('/departments') && method === 'GET':\r\n                return this.authorize(headers, null, () => this.ok(this.departments));\r\n            case url.endsWith('/departments') && method === 'POST':\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const newDepartment: Department = { id: this.nextDepartmentId++, ...body, employeeCount: 0 };\r\n                    this.departments.push(newDepartment);\r\n                    return this.ok(newDepartment, 201);\r\n                });\r\n\r\n            case url.match(/\\/departments\\/(\\d+)$/) && method === 'GET': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, null, () => { // Or specific role if needed\r\n                    const department = this.departments.find(d => d.id === id);\r\n                    return department ? this.ok(department) : this.error(`Department with id ${id} not found`, 404);\r\n                });\r\n            }\r\n            case url.match(/\\/departments\\/(\\d+)$/) && method === 'PUT': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const deptIndex = this.departments.findIndex(d => d.id === id);\r\n                    if (deptIndex === -1) return this.error('Department not found', 404);\r\n                    this.departments[deptIndex] = { ...this.departments[deptIndex], ...body, id };\r\n                    return this.ok(this.departments[deptIndex]);\r\n                });\r\n            }\r\n            case url.match(/\\/departments\\/(\\d+)$/) && method === 'DELETE': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const dept = this.departments.find(d => d.id === id);\r\n                    if (!dept) return this.error('Department not found', 404);\r\n                    if (dept.employeeCount > 0) return this.error('Cannot delete department with active employees.', 400);\r\n                    this.departments = this.departments.filter(d => d.id !== id);\r\n                    return this.ok({ message: 'Department deleted' });\r\n                });\r\n            }\r\n\r\n\r\n            // Workflows\r\n            case url.match(/\\/workflows\\/employee\\/(\\d+)$/) && method === 'GET': {\r\n                const idMatch = url.match(/\\/workflows\\/employee\\/(\\d+)$/);\r\n                if (!idMatch) return this.error('Invalid URL for employee workflows', 400);\r\n                const employeeId = parseInt(idMatch[1]);\r\n                return this.authorize(headers, null, () => {\r\n                    const workflows = this.workflows.filter(w => w.employeeId === employeeId);\r\n                    return this.ok(workflows);\r\n                });\r\n            }\r\n            case url.endsWith('/workflows') && method === 'POST':\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const newWorkflow: Workflow = {\r\n                        id: this.nextWorkflowId++,\r\n                        ...body,\r\n                        datetimecreated: new Date().toISOString() // Add timestamp on creation\r\n                    };\r\n                    this.workflows.push(newWorkflow);\r\n                    return this.ok(newWorkflow, 201);\r\n                });\r\n            // *** ADDED HANDLER FOR GET /workflows ***\r\n            case url.endsWith('/workflows') && method === 'GET':\r\n                return this.authorize(headers, Role.Admin, () => { // Or null if all users can see all workflows\r\n                    // Optional: sort workflows if not already handled by client or a specific query param\r\n                    const sortedWorkflows = [...this.workflows].sort((a, b) => {\r\n                        const dateA = new Date(a.datetimecreated || 0).getTime();\r\n                        const dateB = new Date(b.datetimecreated || 0).getTime();\r\n                        return dateB - dateA; // Descending\r\n                    });\r\n                    return this.ok(sortedWorkflows);\r\n                });\r\n\r\n            // AppRequests\r\n            case url.endsWith('/requests') && method === 'GET':\r\n                return this.authorize(headers, null, () => {\r\n                    const currentAcc = this.currentAccount(headers);\r\n                    if (!currentAcc) return this.unauthorized();\r\n                    if (currentAcc.role === Role.Admin) return this.ok(this.appRequests);\r\n\r\n                    const userRequests = this.appRequests.filter(r => {\r\n                        const emp = this.employees.find(e => e.id === r.employeeId);\r\n                        return emp && emp.userId === currentAcc.id;\r\n                    });\r\n                    return this.ok(userRequests);\r\n                });\r\n            case url.endsWith('/requests') && method === 'POST':\r\n                return this.authorize(headers, null, () => {\r\n                    const currentAcc = this.currentAccount(headers);\r\n                    if (!currentAcc || !currentAcc.employeeId) return this.error(\"User not linked to an employee or not authenticated.\", 400);\r\n\r\n                    const newRequest: AppRequest = { id: this.nextAppRequestId++, employeeId: currentAcc.employeeId, ...body, status: 'Pending' };\r\n                    this.appRequests.push(newRequest);\r\n                    return this.ok(newRequest, 201);\r\n                });\r\n            case url.match(/\\/requests\\/(\\d+)$/) && method === 'GET': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, null, () => { // Allow user to get their own, admin to get any\r\n                    const currentAcc = this.currentAccount(headers);\r\n                    if (!currentAcc) return this.unauthorized();\r\n\r\n                    const request = this.appRequests.find(r => r.id === id);\r\n                    if (!request) {\r\n                        return this.error(`Request with id ${id} not found`, 404);\r\n                    }\r\n\r\n                    // Authorization check: Admin can see any, user can only see their own\r\n                    if (currentAcc.role !== Role.Admin) {\r\n                        const employee = this.employees.find(e => e.id === request.employeeId);\r\n                        if (!employee || employee.userId !== currentAcc.id) {\r\n                            return this.unauthorized(\"You are not authorized to view this request.\");\r\n                        }\r\n                    }\r\n                    return this.ok(request);\r\n                });\r\n            }\r\n\r\n\r\n            default:\r\n                // return next.handle(request); // If you have a real backend\r\n                return throwError(() => new HttpErrorResponse({\r\n                    status: 404, error: { message: `Fake backend: Route not found for ${method} ${url}` }\r\n                }));\r\n        }\r\n    }\r\n\r\n    // --- ACCOUNT MANAGEMENT METHODS ---\r\n    private authenticate(body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const { email, password } = body;\r\n        const account = this.accounts.find(x => x.email === email);\r\n\r\n        if (!account) return this.error('Email does not exist', 400);\r\n        if (!account.isVerified) {\r\n            setTimeout(() => {\r\n                const verifyUrl = `${location.origin}/account/verify-email?token=${account.verificationToken}`;\r\n                this.alertService.info(`<h4>Verification Email</h4><p>Please click the link to verify: <a href=\"${verifyUrl}\">${verifyUrl}</a></p>`, { autoClose: false });\r\n            }, 1000);\r\n            return this.error('Email is not yet verified. Please check your inbox.', 400);\r\n        }\r\n        if (account.password !== password) return this.error('Invalid email or password.', 400);\r\n        if (account.status !== 'Active') return this.error('Account is inactive. Please contact support.', 400);\r\n\r\n        account.refreshTokens = account.refreshTokens || [];\r\n        account.refreshTokens.push(this.generateRefreshTokenForCookie());\r\n        this.saveAccounts();\r\n\r\n        const accountDetails = this.basicDetails(account);\r\n        return this.ok({\r\n            ...accountDetails,\r\n            jwtToken: this.generateJwtToken(account)\r\n        });\r\n    }\r\n\r\n    private refreshToken(body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const requestRefreshTokenFromBody = body.refreshToken;\r\n        const requestRefreshTokenFromCookie = this.getRefreshTokenFromCookie();\r\n        const requestRefreshToken = requestRefreshTokenFromBody || requestRefreshTokenFromCookie;\r\n\r\n\r\n        if (!requestRefreshToken) return this.unauthorized('Refresh token missing.');\r\n\r\n        const account = this.accounts.find(x => x.refreshTokens && x.refreshTokens.includes(requestRefreshToken));\r\n        if (!account) return this.unauthorized('Invalid or expired refresh token.');\r\n\r\n        account.refreshTokens = account.refreshTokens.filter(x => x !== requestRefreshToken);\r\n        account.refreshTokens.push(this.generateRefreshTokenForCookie());\r\n        this.saveAccounts();\r\n\r\n        return this.ok({\r\n            ...this.basicDetails(account),\r\n            jwtToken: this.generateJwtToken(account)\r\n        });\r\n    }\r\n\r\n    private revokeToken(body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const currentAcc = this.currentAccount(headers);\r\n        if (!currentAcc) return this.unauthorized();\r\n\r\n        const tokenToRevoke = body.token || this.getRefreshTokenFromCookie();\r\n        const account = this.accounts.find(x => x.id === currentAcc.id);\r\n\r\n        if (account && account.refreshTokens && tokenToRevoke) {\r\n            account.refreshTokens = account.refreshTokens.filter(x => x !== tokenToRevoke);\r\n            this.saveAccounts();\r\n        }\r\n        if (tokenToRevoke && tokenToRevoke === this.getRefreshTokenFromCookie()) {\r\n            this.clearRefreshTokenCookie();\r\n        }\r\n        return this.ok({ message: 'Token revoked successfully.' });\r\n    }\r\n\r\n    private register(body: any): Observable<HttpEvent<any>> {\r\n        const newAccountData = body as Partial<Account>;\r\n\r\n        if (!newAccountData.email || !newAccountData.password) {\r\n            return this.error('Email and password are required.', 400);\r\n        }\r\n        if (this.accounts.find(x => x.email === newAccountData.email)) {\r\n            setTimeout(() => this.alertService.error(`Email '${newAccountData.email}' is already registered.`), 1000);\r\n            return this.error(`Email '${newAccountData.email}' is already registered.`, 400);\r\n        }\r\n\r\n        const newAccount: Account = {\r\n            id: this.newAccountId(),\r\n            email: newAccountData.email,\r\n            password: newAccountData.password,\r\n            role: this.accounts.length === 0 ? Role.Admin : Role.User,\r\n            firstName: newAccountData.firstName || '',\r\n            lastName: newAccountData.lastName || '',\r\n            title: newAccountData.title || '',\r\n            status: this.accounts.length === 0 ? 'Active' : 'Inactive',\r\n            dateCreated: new Date().toISOString(),\r\n            verificationToken: `${Date.now()}-${Math.random().toString(36).substring(2, 10)}`,\r\n            isVerified: this.accounts.length === 0,\r\n            refreshTokens: []\r\n        };\r\n\r\n        this.accounts.push(newAccount);\r\n        this.saveAccounts();\r\n\r\n        if (!newAccount.isVerified) {\r\n            setTimeout(() => {\r\n                const verifyUrl = `${location.origin}/account/verify-email?token=${newAccount.verificationToken}`;\r\n                this.alertService.info(`<h4>Verification Email</h4><p>Thanks for registering! Please click the link to verify your email: <a href=\"${verifyUrl}\">${verifyUrl}</a></p><div><strong>NOTE:</strong> This is a fake email.</div>`, { autoClose: false });\r\n            }, 1000);\r\n        }\r\n        return this.ok({ message: 'Registration successful. Please check your email to verify your account if required.' }, 201);\r\n    }\r\n\r\n    private verifyEmail(body: any): Observable<HttpEvent<any>> {\r\n        const { token } = body;\r\n        if (!token) return this.error('Verification token is required.', 400);\r\n\r\n        const account = this.accounts.find(x => x.verificationToken === token);\r\n        if (!account) return this.error('Verification failed. Invalid or expired token.', 400);\r\n        if (account.isVerified) return this.ok({ message: 'Email already verified.' });\r\n\r\n\r\n        account.isVerified = true;\r\n        account.status = 'Active';\r\n        delete account.verificationToken;\r\n        this.saveAccounts();\r\n        return this.ok({ message: 'Email verified successfully. You can now login.' });\r\n    }\r\n\r\n    private forgotPassword(body: any): Observable<HttpEvent<any>> {\r\n        const { email } = body;\r\n        if (!email) return this.error('Email is required.', 400);\r\n\r\n        const account = this.accounts.find(x => x.email === email);\r\n        if (account) {\r\n            account.resetToken = `${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;\r\n            account.resetTokenExpires = new Date(Date.now() + 24 * 60 * 60 * 1000);\r\n            this.saveAccounts();\r\n            setTimeout(() => {\r\n                const resetUrl = `${location.origin}/account/reset-password?token=${account.resetToken}`;\r\n                this.alertService.info(`<h4>Reset Password Email</h4><p>Please click the link to reset your password: <a href=\"${resetUrl}\">${resetUrl}</a></p><p>The link will be valid for 24 hours.</p><div><strong>NOTE:</strong> This is a fake email.</div>`, { autoClose: false });\r\n            }, 1000);\r\n        }\r\n        return this.ok({ message: 'If your email address is registered, you will receive a password reset link.' });\r\n    }\r\n\r\n    private validateResetToken(body: any): Observable<HttpEvent<any>> {\r\n        const { token } = body;\r\n        if (!token) return this.error('Reset token is required.', 400);\r\n        const account = this.accounts.find(x => x.resetToken === token && x.resetTokenExpires && new Date(x.resetTokenExpires) > new Date());\r\n        return account ? this.ok({ message: 'Token is valid.' }) : this.error('Invalid or expired reset token.', 400);\r\n    }\r\n\r\n    private resetPassword(body: any): Observable<HttpEvent<any>> {\r\n        const { token, password } = body;\r\n        if (!token || !password) return this.error('Token and new password are required.', 400);\r\n\r\n        const account = this.accounts.find(x => x.resetToken === token && x.resetTokenExpires && new Date(x.resetTokenExpires) > new Date());\r\n        if (!account) return this.error('Invalid or expired reset token.', 400);\r\n\r\n        account.password = password;\r\n        account.isVerified = true;\r\n        account.status = 'Active';\r\n        delete account.resetToken;\r\n        delete account.resetTokenExpires;\r\n        this.saveAccounts();\r\n        return this.ok({ message: 'Password has been reset successfully. You can now login.' });\r\n    }\r\n\r\n    private getAccounts(headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        return this.authorize(headers, Role.Admin, () => {\r\n            return this.ok(this.accounts.map(acc => this.basicDetails(acc)));\r\n        });\r\n    }\r\n\r\n    private getAccountById(id: number, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const currentAcc = this.currentAccount(headers);\r\n        if (!currentAcc) return this.unauthorized();\r\n\r\n        const account = this.accounts.find(x => x.id === id);\r\n        if (!account) return this.error('Account not found', 404);\r\n\r\n        if (currentAcc.role !== Role.Admin && currentAcc.id !== account.id) {\r\n            return this.unauthorized(\"You are not authorized to view this account.\");\r\n        }\r\n        return this.ok(this.basicDetails(account));\r\n    }\r\n\r\n    private createAccount(body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        return this.authorize(headers, Role.Admin, () => {\r\n            const newAccountData = body as Partial<Account>;\r\n            if (!newAccountData.email || !newAccountData.password || !newAccountData.role) {\r\n                return this.error('Email, password, and role are required for new account creation.', 400);\r\n            }\r\n            if (this.accounts.find(x => x.email === newAccountData.email)) {\r\n                return this.error(`Email '${newAccountData.email}' is already registered`, 400);\r\n            }\r\n            const newAccount: Account = {\r\n                id: this.newAccountId(),\r\n                email: newAccountData.email,\r\n                password: newAccountData.password,\r\n                role: newAccountData.role,\r\n                firstName: newAccountData.firstName || '',\r\n                lastName: newAccountData.lastName || '',\r\n                title: newAccountData.title || '',\r\n                dateCreated: new Date().toISOString(),\r\n                isVerified: true,\r\n                status: 'Active',\r\n                refreshTokens: [],\r\n                employeeId: newAccountData.employeeId\r\n            };\r\n            this.accounts.push(newAccount);\r\n            this.saveAccounts();\r\n            return this.ok(this.basicDetails(newAccount), 201);\r\n        });\r\n    }\r\n\r\n    private updateAccount(id: number, body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const currentAcc = this.currentAccount(headers);\r\n        if (!currentAcc) return this.unauthorized();\r\n\r\n        const accountIndex = this.accounts.findIndex(x => x.id === id);\r\n        if (accountIndex === -1) return this.error('Account not found', 404);\r\n        const accountToUpdate = this.accounts[accountIndex];\r\n\r\n        if (currentAcc.role !== Role.Admin && currentAcc.id !== accountToUpdate.id) {\r\n            return this.unauthorized(\"You are not authorized to update this account.\");\r\n        }\r\n\r\n        const updateData = { ...body } as Partial<Account>;\r\n        if (currentAcc.id === accountToUpdate.id && currentAcc.role !== Role.Admin && updateData.role && updateData.role !== accountToUpdate.role) {\r\n            return this.error(\"You cannot change your own role.\", 403);\r\n        }\r\n\r\n        if (updateData.password) {\r\n            accountToUpdate.password = updateData.password;\r\n        }\r\n        ['firstName', 'lastName', 'title', 'email', 'role', 'status', 'employeeId'].forEach(field => {\r\n            if (updateData[field] !== undefined) {\r\n                accountToUpdate[field] = updateData[field];\r\n            }\r\n        });\r\n\r\n        accountToUpdate.dateUpdated = new Date().toISOString();\r\n        this.accounts[accountIndex] = accountToUpdate;\r\n        this.saveAccounts();\r\n        return this.ok(this.basicDetails(accountToUpdate));\r\n    }\r\n\r\n    private deleteAccount(id: number, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const currentAcc = this.currentAccount(headers);\r\n        if (!currentAcc) return this.unauthorized();\r\n\r\n        const accountIndex = this.accounts.findIndex(x => x.id === id);\r\n        if (accountIndex === -1) return this.error('Account not found', 404);\r\n\r\n        const accountToDelete = this.accounts[accountIndex];\r\n        if (currentAcc.role !== Role.Admin && currentAcc.id !== accountToDelete.id) {\r\n            return this.unauthorized(\"You are not authorized to delete this account.\");\r\n        }\r\n        if (accountToDelete.id === currentAcc.id && accountToDelete.role === Role.Admin && this.accounts.filter(a => a.role === Role.Admin).length <= 1) {\r\n            return this.error(\"Cannot delete the last admin account.\", 400);\r\n        }\r\n\r\n        this.accounts.splice(accountIndex, 1);\r\n        this.saveAccounts();\r\n        if (accountToDelete.id === currentAcc.id) {\r\n            this.clearRefreshTokenCookie();\r\n        }\r\n        return this.ok({ message: 'Account deleted successfully.' });\r\n    }\r\n\r\n    // --- HELPER METHODS ---\r\n    private ok(body?: any, status = 200): Observable<HttpResponse<any>> {\r\n        return of(new HttpResponse({ status, body }));\r\n    }\r\n\r\n    private error(message: string, status = 400): Observable<HttpEvent<never>> {\r\n        return throwError(() => new HttpErrorResponse({ error: { message }, status }));\r\n    }\r\n\r\n    private unauthorized(message = 'Unauthorized'): Observable<HttpEvent<never>> {\r\n        return throwError(() => new HttpErrorResponse({ status: 401, error: { message } }));\r\n    }\r\n\r\n    private basicDetails(account: Account): Partial<Account> {\r\n        const { id, title, firstName, lastName, email, role, dateCreated, dateUpdated, isVerified, status, employeeId } = account;\r\n        return { id, title, firstName, lastName, email, role, dateCreated, dateUpdated, isVerified, status, employeeId };\r\n    }\r\n\r\n    private currentAccount(headers: HttpHeaders): Account | undefined {\r\n        const authHeader = headers.get('Authorization');\r\n        if (!authHeader || !authHeader.startsWith('Bearer ')) return undefined;\r\n\r\n        const token = authHeader.substring(7);\r\n        try {\r\n            const payloadB64 = token.split('.')[1];\r\n            if (!payloadB64) return undefined;\r\n\r\n            const tokenPayload = JSON.parse(atob(payloadB64));\r\n            if (Date.now() >= tokenPayload.exp * 1000) {\r\n                console.warn(\"Fake backend: JWT token expired\");\r\n                this.clearRefreshTokenCookie();\r\n                return undefined;\r\n            }\r\n            return this.accounts.find(x => x.id === tokenPayload.id);\r\n        } catch (e) {\r\n            console.error(\"Fake backend: Error parsing JWT token\", e);\r\n            return undefined;\r\n        }\r\n    }\r\n\r\n    private authorize(headers: HttpHeaders, requiredRole: Role | string | null, successCallback: () => Observable<HttpEvent<any>>): Observable<HttpEvent<any>> {\r\n        const account = this.currentAccount(headers);\r\n        if (!account) {\r\n            return this.unauthorized('Missing or invalid authentication token.');\r\n        }\r\n        if (requiredRole && account.role !== requiredRole) {\r\n            return throwError(() => new HttpErrorResponse({ status: 403, error: { message: 'Forbidden - Insufficient permissions' } }));\r\n        }\r\n        return successCallback();\r\n    }\r\n\r\n    private idFromUrl(url: string): number {\r\n        const match = url.match(/\\/(\\d+)$/);\r\n        return match ? parseInt(match[1], 10) : -1;\r\n    }\r\n\r\n    private newAccountId(): number {\r\n        return this.accounts.length ? Math.max(0, ...this.accounts.map(x => x.id)) + 1 : 1;\r\n    }\r\n\r\n    private saveAccounts(): void {\r\n        localStorage.setItem(accountsKey, JSON.stringify(this.accounts));\r\n    }\r\n\r\n    private generateJwtToken(account: Account): string {\r\n        const payload = {\r\n            id: account.id,\r\n            role: account.role,\r\n            email: account.email,\r\n            exp: Math.floor(new Date(Date.now() + 15 * 60 * 1000).getTime() / 1000),\r\n        };\r\n        const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));\r\n        const encodedPayload = btoa(JSON.stringify(payload));\r\n        return `${header}.${encodedPayload}.fake-signature-for-demo-only`;\r\n    }\r\n\r\n    private generateRefreshTokenForCookie(): string {\r\n        const token = `${Date.now()}-${Math.random().toString(36).substring(2, 12)}`;\r\n        const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toUTCString();\r\n        if (typeof document !== 'undefined') {\r\n            document.cookie = `fakeRefreshToken=${token}; expires=${expires}; path=/; SameSite=Lax`;\r\n        }\r\n        return token;\r\n    }\r\n\r\n    private getRefreshTokenFromCookie(): string | undefined {\r\n        if (typeof document === 'undefined') return undefined;\r\n        const cookies = document.cookie.split(';');\r\n        for (let cookie of cookies) {\r\n            const [name, value] = cookie.trim().split('=');\r\n            if (name === 'fakeRefreshToken') {\r\n                return value;\r\n            }\r\n        }\r\n        return undefined;\r\n    }\r\n\r\n    private clearRefreshTokenCookie(): void {\r\n        if (typeof document !== 'undefined') {\r\n            document.cookie = 'fakeRefreshToken=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax';\r\n        }\r\n    }\r\n}\r\n\r\nexport const fakeBackendProvider = {\r\n    provide: HTTP_INTERCEPTORS,\r\n    useClass: FakeBackendInterceptor,\r\n    multi: true\r\n};"]},"metadata":{},"sourceType":"module","externalDependencies":[]}