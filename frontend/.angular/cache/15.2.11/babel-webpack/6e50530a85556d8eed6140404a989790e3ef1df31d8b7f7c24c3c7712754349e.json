{"ast":null,"code":"import { HttpResponse, HTTP_INTERCEPTORS, HttpErrorResponse } from '@angular/common/http';\nimport { of, throwError } from 'rxjs';\nimport { delay, mergeMap, materialize, dematerialize } from 'rxjs/operators';\nimport { Role } from '@app/_models'; // Assuming this path is correct\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@app/_services\";\n// Key for localStorage\nconst accountsKey = 'app-hr-tool-accounts'; // Made key more specific\nexport let FakeBackendInterceptor = /*#__PURE__*/(() => {\n  class FakeBackendInterceptor {\n    constructor(alertService) {\n      this.alertService = alertService;\n      // In-memory for other entities\n      this.employees = [{\n        id: 1,\n        employeeId: 'EMP001',\n        userId: 1,\n        email: 'admin@example.com',\n        position: 'Developer',\n        departmentId: 1,\n        hireDate: '2025-01-01',\n        status: 'Active'\n      }, {\n        id: 2,\n        employeeId: 'EMP002',\n        userId: 2,\n        email: 'user@example.com',\n        position: 'Designer',\n        departmentId: 2,\n        hireDate: '2025-02-01',\n        status: 'Active'\n      }];\n      this.departments = [{\n        id: 1,\n        name: 'Engineering',\n        description: 'Software development team',\n        employeeCount: 1\n      }, {\n        id: 2,\n        name: 'Marketing',\n        description: 'Marketing team',\n        employeeCount: 1\n      }];\n      this.workflows = [{\n        id: 1,\n        employeeId: 1,\n        type: 'Onboarding',\n        details: {\n          task: 'Setup workstation'\n        },\n        status: 'Pending',\n        datetimecreated: new Date(Date.now() - 100000).toISOString()\n      }, {\n        id: 2,\n        employeeId: 2,\n        type: 'Offboarding',\n        details: {\n          task: 'Return equipment'\n        },\n        status: 'Completed',\n        datetimecreated: new Date(Date.now() - 200000).toISOString()\n      }];\n      this.appRequests = [{\n        id: 1,\n        employeeId: 2,\n        type: 'Equipment',\n        requestItems: [{\n          name: 'Laptop',\n          quantity: 1\n        }],\n        status: 'Pending'\n      }];\n      // ID Generators for in-memory entities\n      this.nextEmployeeId = this.employees.length > 0 ? Math.max(0, ...this.employees.map(e => e.id)) + 1 : 1;\n      this.nextDepartmentId = this.departments.length > 0 ? Math.max(0, ...this.departments.map(d => d.id)) + 1 : 1;\n      this.nextWorkflowId = this.workflows.length > 0 ? Math.max(0, ...this.workflows.map(w => w.id)) + 1 : 1;\n      this.nextAppRequestId = this.appRequests.length > 0 ? Math.max(0, ...this.appRequests.map(r => r.id)) + 1 : 1;\n      this.accounts = JSON.parse(localStorage.getItem(accountsKey)) || [];\n      // Ensure default admin/user if local storage is empty or new\n      if (this.accounts.length === 0) {\n        this.accounts.push({\n          id: 1,\n          title: 'Mr',\n          email: 'admin@example.com',\n          password: 'admin',\n          role: Role.Admin,\n          employeeId: 1,\n          isVerified: true,\n          status: 'Active',\n          refreshTokens: [],\n          dateCreated: new Date().toISOString(),\n          firstName: 'Admin',\n          lastName: 'User'\n        });\n        this.accounts.push({\n          id: 2,\n          title: 'Mr',\n          email: 'user@example.com',\n          password: 'user',\n          role: Role.User,\n          employeeId: 2,\n          isVerified: true,\n          status: 'Active',\n          refreshTokens: [],\n          dateCreated: new Date().toISOString(),\n          firstName: 'Normal',\n          lastName: 'User'\n        });\n        this.saveAccounts();\n      }\n    }\n    intercept(request, next) {\n      const {\n        url,\n        method,\n        headers,\n        body\n      } = request;\n      return of(null).pipe(mergeMap(() => this.handleRoute(url, method, headers, body, next))).pipe(materialize()).pipe(delay(500)).pipe(dematerialize());\n    }\n    handleRoute(url, method, headers, body, next) {\n      // --- ACCOUNT MANAGEMENT ROUTES ---\n      switch (true) {\n        case url.endsWith('/accounts/authenticate') && method === 'POST':\n          return this.authenticate(body, headers);\n        case url.endsWith('/accounts/refresh-token') && method === 'POST':\n          return this.refreshToken(body, headers);\n        case url.endsWith('/accounts/revoke-token') && method === 'POST':\n          return this.revokeToken(body, headers);\n        case url.endsWith('/accounts/register') && method === 'POST':\n          return this.register(body);\n        case url.endsWith('/accounts/verify-email') && method === 'POST':\n          return this.verifyEmail(body);\n        case url.endsWith('/accounts/forgot-password') && method === 'POST':\n          return this.forgotPassword(body);\n        case url.endsWith('/accounts/validate-reset-token') && method === 'POST':\n          return this.validateResetToken(body);\n        case url.endsWith('/accounts/reset-password') && method === 'POST':\n          return this.resetPassword(body);\n        case url.endsWith('/accounts') && method === 'GET':\n          return this.getAccounts(headers);\n        case url.match(/\\/accounts\\/(\\d+)$/) && method === 'GET':\n          return this.getAccountById(this.idFromUrl(url), headers);\n        case url.endsWith('/accounts') && method === 'POST':\n          return this.createAccount(body, headers);\n        case url.match(/\\/accounts\\/(\\d+)$/) && method === 'PUT':\n          return this.updateAccount(this.idFromUrl(url), body, headers);\n        case url.match(/\\/accounts\\/(\\d+)$/) && method === 'DELETE':\n          return this.deleteAccount(this.idFromUrl(url), headers);\n        // --- OTHER ENTITY ROUTES ---\n        // Employees\n        case url.endsWith('/employees') && method === 'GET':\n          return this.authorize(headers, null, () => this.ok(this.employees));\n        case url.endsWith('/employees') && method === 'POST':\n          return this.authorize(headers, Role.Admin, () => {\n            const newEmployee = Object.assign({\n              id: this.nextEmployeeId++\n            }, body);\n            this.employees.push(newEmployee);\n            const dept = this.departments.find(d => d.id === newEmployee.departmentId);\n            if (dept) dept.employeeCount++;\n            return this.ok(newEmployee, 201);\n          });\n        case url.match(/\\/employees\\/(\\d+)$/) && method === 'GET':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, null, () => {\n              const employee = this.employees.find(e => e.id === id);\n              return employee ? this.ok(employee) : this.error('Employee not found', 404);\n            });\n          }\n        // In FakeBackendInterceptor, within the handleRoute method:\n        case url.match(/\\/employees\\/(\\d+)$/) && method === 'PUT':\n          {\n            const id = this.idFromUrl(url); // This is the employee's ID (number)\n            console.log(`PUT /employees/${id} - Request Body:`, JSON.stringify(body));\n            return this.authorize(headers, Role.Admin, () => {\n              const employeeIndex = this.employees.findIndex(e => e.id === id);\n              if (employeeIndex === -1) return this.error('Employee not found', 404);\n              const oldEmployeeData = this.employees[employeeIndex];\n              // Create updatedEmployee, ensuring body properties are merged\n              const updatedEmployee = Object.assign(Object.assign(Object.assign({}, oldEmployeeData), body), {\n                id\n              });\n              // Ensure the departmentId from the body is treated as a number for comparison\n              const targetDepartmentIdFromBody = updatedEmployee.departmentId !== undefined && updatedEmployee.departmentId !== null ? parseInt(String(updatedEmployee.departmentId), 10) : undefined;\n              // Update departmentId on the employee object IF it was provided in the body\n              if (targetDepartmentIdFromBody !== undefined && !isNaN(targetDepartmentIdFromBody)) {\n                updatedEmployee.departmentId = targetDepartmentIdFromBody;\n              }\n              if (oldEmployeeData.departmentId !== updatedEmployee.departmentId) {\n                const oldDept = this.departments.find(d => d.id === oldEmployeeData.departmentId);\n                if (oldDept) oldDept.employeeCount = Math.max(0, oldDept.employeeCount - 1);\n                // Now updatedEmployee.departmentId should be a number if it was valid\n                const newDept = this.departments.find(d => d.id === updatedEmployee.departmentId);\n                if (newDept) {\n                  newDept.employeeCount++;\n                } else if (updatedEmployee.departmentId !== oldEmployeeData.departmentId) {\n                  // Only error if a new, non-existent departmentId was attempted\n                  return this.error(`Target department with id '${updatedEmployee.departmentId}' not found`, 400);\n                }\n              }\n              this.employees[employeeIndex] = updatedEmployee;\n              return this.ok(this.employees[employeeIndex]);\n            });\n          }\n        case url.match(/\\/employees\\/(\\d+)$/) && method === 'DELETE':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, Role.Admin, () => {\n              const employeeIndex = this.employees.findIndex(e => e.id === id);\n              if (employeeIndex === -1) return this.error('Employee not found', 404);\n              const deletedEmployee = this.employees.splice(employeeIndex, 1)[0];\n              if (deletedEmployee) {\n                const dept = this.departments.find(d => d.id === deletedEmployee.departmentId);\n                if (dept) dept.employeeCount = Math.max(0, dept.employeeCount - 1);\n              }\n              return this.ok({\n                message: 'Employee deleted'\n              });\n            });\n          }\n        case url.match(/\\/employees\\/(\\d+)\\/transfer$/) && method === 'POST':\n          {\n            const idMatch = url.match(/\\/employees\\/(\\d+)\\/transfer$/);\n            if (!idMatch) return this.error('Invalid URL for employee transfer', 400);\n            const id = parseInt(idMatch[1]);\n            return this.authorize(headers, Role.Admin, () => {\n              const employee = this.employees.find(e => e.id === id);\n              if (!employee) return this.error('Employee not found', 404);\n              const oldDepartmentId = employee.departmentId;\n              const newDepartmentId = body.departmentId;\n              if (oldDepartmentId !== newDepartmentId) {\n                const oldDept = this.departments.find(d => d.id === oldDepartmentId);\n                if (oldDept) oldDept.employeeCount = Math.max(0, oldDept.employeeCount - 1);\n                const newDept = this.departments.find(d => d.id === newDepartmentId);\n                if (newDept) newDept.employeeCount++;else return this.error('Target department not found', 400);\n              }\n              employee.departmentId = newDepartmentId;\n              this.workflows.push({\n                id: this.nextWorkflowId++,\n                employeeId: id,\n                type: 'Transfer',\n                details: body,\n                status: 'Pending',\n                datetimecreated: new Date().toISOString()\n              });\n              return this.ok({\n                message: 'Employee transferred successfully',\n                employee\n              });\n            });\n          }\n        // Departments\n        case url.endsWith('/departments') && method === 'GET':\n          return this.authorize(headers, null, () => this.ok(this.departments));\n        case url.endsWith('/departments') && method === 'POST':\n          return this.authorize(headers, Role.Admin, () => {\n            const newDepartment = Object.assign(Object.assign({\n              id: this.nextDepartmentId++\n            }, body), {\n              employeeCount: 0\n            });\n            this.departments.push(newDepartment);\n            return this.ok(newDepartment, 201);\n          });\n        case url.match(/\\/departments\\/(\\d+)$/) && method === 'GET':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, null, () => {\n              const department = this.departments.find(d => d.id === id);\n              return department ? this.ok(department) : this.error(`Department with id ${id} not found`, 404);\n            });\n          }\n        case url.match(/\\/departments\\/(\\d+)$/) && method === 'PUT':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, Role.Admin, () => {\n              const deptIndex = this.departments.findIndex(d => d.id === id);\n              if (deptIndex === -1) return this.error('Department not found', 404);\n              this.departments[deptIndex] = Object.assign(Object.assign(Object.assign({}, this.departments[deptIndex]), body), {\n                id\n              });\n              return this.ok(this.departments[deptIndex]);\n            });\n          }\n        case url.match(/\\/departments\\/(\\d+)$/) && method === 'DELETE':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, Role.Admin, () => {\n              const dept = this.departments.find(d => d.id === id);\n              if (!dept) return this.error('Department not found', 404);\n              if (dept.employeeCount > 0) return this.error('Cannot delete department with active employees.', 400);\n              this.departments = this.departments.filter(d => d.id !== id);\n              return this.ok({\n                message: 'Department deleted'\n              });\n            });\n          }\n        // Workflows\n        case url.match(/\\/workflows\\/employee\\/(\\d+)$/) && method === 'GET':\n          {\n            const idMatch = url.match(/\\/workflows\\/employee\\/(\\d+)$/);\n            if (!idMatch) return this.error('Invalid URL for employee workflows', 400);\n            const employeeId = parseInt(idMatch[1]);\n            return this.authorize(headers, null, () => {\n              const workflows = this.workflows.filter(w => w.employeeId === employeeId);\n              return this.ok(workflows);\n            });\n          }\n        case url.endsWith('/workflows') && method === 'POST':\n          return this.authorize(headers, Role.Admin, () => {\n            const newWorkflow = Object.assign(Object.assign({\n              id: this.nextWorkflowId++\n            }, body), {\n              datetimecreated: new Date().toISOString() // Add timestamp on creation\n            });\n\n            this.workflows.push(newWorkflow);\n            return this.ok(newWorkflow, 201);\n          });\n        // *** ADDED HANDLER FOR GET /workflows ***\n        case url.endsWith('/workflows') && method === 'GET':\n          return this.authorize(headers, Role.Admin, () => {\n            // Optional: sort workflows if not already handled by client or a specific query param\n            const sortedWorkflows = [...this.workflows].sort((a, b) => {\n              const dateA = new Date(a.datetimecreated || 0).getTime();\n              const dateB = new Date(b.datetimecreated || 0).getTime();\n              return dateB - dateA; // Descending\n            });\n\n            return this.ok(sortedWorkflows);\n          });\n        // AppRequests\n        case url.endsWith('/requests') && method === 'GET':\n          return this.authorize(headers, null, () => {\n            const currentAcc = this.currentAccount(headers);\n            if (!currentAcc) return this.unauthorized();\n            if (currentAcc.role === Role.Admin) return this.ok(this.appRequests);\n            const userRequests = this.appRequests.filter(r => {\n              const emp = this.employees.find(e => e.id === r.employeeId);\n              return emp && emp.userId === currentAcc.id;\n            });\n            return this.ok(userRequests);\n          });\n        case url.endsWith('/requests') && method === 'POST':\n          return this.authorize(headers, null, () => {\n            const currentAcc = this.currentAccount(headers);\n            if (!currentAcc || !currentAcc.employeeId) return this.error(\"User not linked to an employee or not authenticated.\", 400);\n            const newRequest = Object.assign(Object.assign({\n              id: this.nextAppRequestId++,\n              employeeId: currentAcc.employeeId\n            }, body), {\n              status: 'Pending'\n            });\n            this.appRequests.push(newRequest);\n            return this.ok(newRequest, 201);\n          });\n        case url.match(/\\/requests\\/(\\d+)$/) && method === 'GET':\n          {\n            const id = this.idFromUrl(url);\n            return this.authorize(headers, null, () => {\n              const currentAcc = this.currentAccount(headers);\n              if (!currentAcc) return this.unauthorized();\n              const request = this.appRequests.find(r => r.id === id);\n              if (!request) {\n                return this.error(`Request with id ${id} not found`, 404);\n              }\n              // Authorization check: Admin can see any, user can only see their own\n              if (currentAcc.role !== Role.Admin) {\n                const employee = this.employees.find(e => e.id === request.employeeId);\n                if (!employee || employee.userId !== currentAcc.id) {\n                  return this.unauthorized(\"You are not authorized to view this request.\");\n                }\n              }\n              return this.ok(request);\n            });\n          }\n        default:\n          // return next.handle(request); // If you have a real backend\n          return throwError(() => new HttpErrorResponse({\n            status: 404,\n            error: {\n              message: `Fake backend: Route not found for ${method} ${url}`\n            }\n          }));\n      }\n    }\n    // --- ACCOUNT MANAGEMENT METHODS ---\n    authenticate(body, headers) {\n      const {\n        email,\n        password\n      } = body;\n      const account = this.accounts.find(x => x.email === email);\n      if (!account) return this.error('Email does not exist', 400);\n      if (!account.isVerified) {\n        setTimeout(() => {\n          const verifyUrl = `${location.origin}/account/verify-email?token=${account.verificationToken}`;\n          this.alertService.info(`<h4>Verification Email</h4><p>Please click the link to verify: <a href=\"${verifyUrl}\">${verifyUrl}</a></p>`, {\n            autoClose: false\n          });\n        }, 1000);\n        return this.error('Email is not yet verified.', 400);\n      }\n      if (account.password !== password) return this.error('Incorrect password.', 400);\n      if (account.status !== 'Active') return this.error('Account is inactive. Please contact support.', 400);\n      account.refreshTokens = account.refreshTokens || [];\n      account.refreshTokens.push(this.generateRefreshTokenForCookie());\n      this.saveAccounts();\n      const accountDetails = this.basicDetails(account);\n      return this.ok(Object.assign(Object.assign({}, accountDetails), {\n        jwtToken: this.generateJwtToken(account)\n      }));\n    }\n    refreshToken(body, headers) {\n      const requestRefreshTokenFromBody = body.refreshToken;\n      const requestRefreshTokenFromCookie = this.getRefreshTokenFromCookie();\n      const requestRefreshToken = requestRefreshTokenFromBody || requestRefreshTokenFromCookie;\n      if (!requestRefreshToken) return this.unauthorized('Refresh token missing.');\n      const account = this.accounts.find(x => x.refreshTokens && x.refreshTokens.includes(requestRefreshToken));\n      if (!account) return this.unauthorized('Invalid or expired refresh token.');\n      account.refreshTokens = account.refreshTokens.filter(x => x !== requestRefreshToken);\n      account.refreshTokens.push(this.generateRefreshTokenForCookie());\n      this.saveAccounts();\n      return this.ok(Object.assign(Object.assign({}, this.basicDetails(account)), {\n        jwtToken: this.generateJwtToken(account)\n      }));\n    }\n    revokeToken(body, headers) {\n      const currentAcc = this.currentAccount(headers);\n      if (!currentAcc) return this.unauthorized();\n      const tokenToRevoke = body.token || this.getRefreshTokenFromCookie();\n      const account = this.accounts.find(x => x.id === currentAcc.id);\n      if (account && account.refreshTokens && tokenToRevoke) {\n        account.refreshTokens = account.refreshTokens.filter(x => x !== tokenToRevoke);\n        this.saveAccounts();\n      }\n      if (tokenToRevoke && tokenToRevoke === this.getRefreshTokenFromCookie()) {\n        this.clearRefreshTokenCookie();\n      }\n      return this.ok({\n        message: 'Token revoked successfully.'\n      });\n    }\n    register(body) {\n      const newAccountData = body;\n      if (!newAccountData.email || !newAccountData.password) {\n        return this.error('Email and password are required.', 400);\n      }\n      if (this.accounts.find(x => x.email === newAccountData.email)) {\n        setTimeout(() => {\n          this.alertService.info(`\n                        <h4>Email Already Registered</h4>\n                        <p>Your email ${newAccountData.email} is already registered.</p>\n                        <p>If you don't know your password please visit the <a href=\"${location.origin}/account/forgot-password\">forgot password</a> page.</p>\n                        <div>\n                        <strong>NOTE:</strong> The fake backend displayed this \"email\" so you can test without an API. A real backend would send a real email.\n                        </div>\n                    `, {\n            autoclose: false\n          });\n        }, 1000);\n        return this.error(`Email '${newAccountData.email}' is already registered.`, 400);\n      }\n      const newAccount = {\n        id: this.newAccountId(),\n        email: newAccountData.email,\n        password: newAccountData.password,\n        role: this.accounts.length === 0 ? Role.Admin : Role.User,\n        firstName: newAccountData.firstName || '',\n        lastName: newAccountData.lastName || '',\n        title: newAccountData.title || '',\n        status: this.accounts.length === 0 ? 'Active' : 'Inactive',\n        dateCreated: new Date().toISOString(),\n        verificationToken: `${Date.now()}-${Math.random().toString(36).substring(2, 10)}`,\n        isVerified: this.accounts.length === 0,\n        refreshTokens: []\n      };\n      this.accounts.push(newAccount);\n      this.saveAccounts();\n      if (!newAccount.isVerified) {\n        setTimeout(() => {\n          const verifyUrl = `${location.origin}/account/verify-email?token=${newAccount.verificationToken}`;\n          this.alertService.info(`<h4>Verification Email</h4><p>Thanks for registering! Please click the link to verify your email: <a href=\"${verifyUrl}\">${verifyUrl}</a></p><div><strong>NOTE:</strong> This is a fake email.</div>`, {\n            autoClose: false\n          });\n        }, 1000);\n      }\n      return this.ok({\n        message: 'Registration successful. Please check your email to verify your account if required.'\n      }, 201);\n    }\n    verifyEmail(body) {\n      const {\n        token\n      } = body;\n      if (!token) return this.error('Verification token is required.', 400);\n      const account = this.accounts.find(x => x.verificationToken === token);\n      if (!account) return this.error('Verification failed.', 400);\n      if (account.isVerified) return this.ok({\n        message: 'Email already verified.'\n      });\n      account.isVerified = true;\n      account.status = 'Active';\n      delete account.verificationToken;\n      this.saveAccounts();\n      return this.ok({\n        message: 'Email verified successfully. You can now login.'\n      });\n    }\n    forgotPassword(body) {\n      const {\n        email\n      } = body;\n      if (!email) return this.error('Email is required.', 400);\n      const account = this.accounts.find(x => x.email === email);\n      if (account) {\n        account.resetToken = `${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;\n        account.resetTokenExpires = new Date(Date.now() + 24 * 60 * 60 * 1000);\n        this.saveAccounts();\n        setTimeout(() => {\n          const resetUrl = `${location.origin}/account/reset-password?token=${account.resetToken}`;\n          this.alertService.info(`<h4>Reset Password Email</h4><p>Please click the link to reset your password: <a href=\"${resetUrl}\">${resetUrl}</a></p><p>The link will be valid for 24 hours.</p><div><strong>NOTE:</strong> This is a fake email.</div>`, {\n            autoClose: false\n          });\n        }, 1000);\n      }\n      return this.ok({\n        message: 'If your email address is registered, you will receive a password reset link.'\n      });\n    }\n    validateResetToken(body) {\n      const {\n        token\n      } = body;\n      if (!token) return this.error('Reset token is required.', 400);\n      const account = this.accounts.find(x => x.resetToken === token && x.resetTokenExpires && new Date(x.resetTokenExpires) > new Date());\n      return account ? this.ok({\n        message: 'Token is valid.'\n      }) : this.error('Invalid or expired reset token.', 400);\n    }\n    resetPassword(body) {\n      const {\n        token,\n        password\n      } = body;\n      if (!token || !password) return this.error('Token and new password are required.', 400);\n      const account = this.accounts.find(x => x.resetToken === token && x.resetTokenExpires && new Date(x.resetTokenExpires) > new Date());\n      if (!account) return this.error('Invalid or expired reset token.', 400);\n      account.password = password;\n      account.isVerified = true;\n      account.status = 'Active';\n      delete account.resetToken;\n      delete account.resetTokenExpires;\n      this.saveAccounts();\n      return this.ok({\n        message: 'Password has been reset successfully. You can now login.'\n      });\n    }\n    getAccounts(headers) {\n      return this.authorize(headers, Role.Admin, () => {\n        return this.ok(this.accounts.map(acc => this.basicDetails(acc)));\n      });\n    }\n    getAccountById(id, headers) {\n      const currentAcc = this.currentAccount(headers);\n      if (!currentAcc) return this.unauthorized();\n      const account = this.accounts.find(x => x.id === id);\n      if (!account) return this.error('Account not found', 404);\n      if (currentAcc.role !== Role.Admin && currentAcc.id !== account.id) {\n        return this.unauthorized(\"You are not authorized to view this account.\");\n      }\n      return this.ok(this.basicDetails(account));\n    }\n    createAccount(body, headers) {\n      return this.authorize(headers, Role.Admin, () => {\n        const newAccountData = body;\n        if (!newAccountData.email || !newAccountData.password || !newAccountData.role) {\n          return this.error('Email, password, and role are required for new account creation.', 400);\n        }\n        if (this.accounts.find(x => x.email === newAccountData.email)) {\n          return this.error(`Email '${newAccountData.email}' is already registered`, 400);\n        }\n        const newAccount = {\n          id: this.newAccountId(),\n          email: newAccountData.email,\n          password: newAccountData.password,\n          role: newAccountData.role,\n          firstName: newAccountData.firstName || '',\n          lastName: newAccountData.lastName || '',\n          title: newAccountData.title || '',\n          dateCreated: new Date().toISOString(),\n          isVerified: true,\n          status: 'Active',\n          refreshTokens: [],\n          employeeId: newAccountData.employeeId\n        };\n        this.accounts.push(newAccount);\n        this.saveAccounts();\n        return this.ok(this.basicDetails(newAccount), 201);\n      });\n    }\n    updateAccount(id, body, headers) {\n      const currentAcc = this.currentAccount(headers);\n      if (!currentAcc) return this.unauthorized();\n      const accountIndex = this.accounts.findIndex(x => x.id === id);\n      if (accountIndex === -1) return this.error('Account not found', 404);\n      const accountToUpdate = this.accounts[accountIndex];\n      if (currentAcc.role !== Role.Admin && currentAcc.id !== accountToUpdate.id) {\n        return this.unauthorized(\"You are not authorized to update this account.\");\n      }\n      const updateData = Object.assign({}, body);\n      if (currentAcc.id === accountToUpdate.id && currentAcc.role !== Role.Admin && updateData.role && updateData.role !== accountToUpdate.role) {\n        return this.error(\"You cannot change your own role.\", 403);\n      }\n      if (updateData.password) {\n        accountToUpdate.password = updateData.password;\n      }\n      ['firstName', 'lastName', 'title', 'email', 'role', 'status', 'employeeId'].forEach(field => {\n        if (updateData[field] !== undefined) {\n          accountToUpdate[field] = updateData[field];\n        }\n      });\n      accountToUpdate.dateUpdated = new Date().toISOString();\n      this.accounts[accountIndex] = accountToUpdate;\n      this.saveAccounts();\n      return this.ok(this.basicDetails(accountToUpdate));\n    }\n    deleteAccount(id, headers) {\n      const currentAcc = this.currentAccount(headers);\n      if (!currentAcc) return this.unauthorized();\n      const accountIndex = this.accounts.findIndex(x => x.id === id);\n      if (accountIndex === -1) return this.error('Account not found', 404);\n      const accountToDelete = this.accounts[accountIndex];\n      if (currentAcc.role !== Role.Admin && currentAcc.id !== accountToDelete.id) {\n        return this.unauthorized(\"You are not authorized to delete this account.\");\n      }\n      if (accountToDelete.id === currentAcc.id && accountToDelete.role === Role.Admin && this.accounts.filter(a => a.role === Role.Admin).length <= 1) {\n        return this.error(\"Cannot delete the last admin account.\", 400);\n      }\n      this.accounts.splice(accountIndex, 1);\n      this.saveAccounts();\n      if (accountToDelete.id === currentAcc.id) {\n        this.clearRefreshTokenCookie();\n      }\n      return this.ok({\n        message: 'Account deleted successfully.'\n      });\n    }\n    // --- HELPER METHODS ---\n    ok(body, status = 200) {\n      return of(new HttpResponse({\n        status,\n        body\n      }));\n    }\n    error(message, status = 400) {\n      return throwError(() => new HttpErrorResponse({\n        error: {\n          message\n        },\n        status\n      }));\n    }\n    unauthorized(message = 'Unauthorized') {\n      return throwError(() => new HttpErrorResponse({\n        status: 401,\n        error: {\n          message\n        }\n      }));\n    }\n    basicDetails(account) {\n      const {\n        id,\n        title,\n        firstName,\n        lastName,\n        email,\n        role,\n        dateCreated,\n        dateUpdated,\n        isVerified,\n        status,\n        employeeId\n      } = account;\n      return {\n        id,\n        title,\n        firstName,\n        lastName,\n        email,\n        role,\n        dateCreated,\n        dateUpdated,\n        isVerified,\n        status,\n        employeeId\n      };\n    }\n    currentAccount(headers) {\n      const authHeader = headers.get('Authorization');\n      if (!authHeader || !authHeader.startsWith('Bearer ')) return undefined;\n      const token = authHeader.substring(7);\n      try {\n        const payloadB64 = token.split('.')[1];\n        if (!payloadB64) return undefined;\n        const tokenPayload = JSON.parse(atob(payloadB64));\n        if (Date.now() >= tokenPayload.exp * 1000) {\n          console.warn(\"Fake backend: JWT token expired\");\n          this.clearRefreshTokenCookie();\n          return undefined;\n        }\n        return this.accounts.find(x => x.id === tokenPayload.id);\n      } catch (e) {\n        console.error(\"Fake backend: Error parsing JWT token\", e);\n        return undefined;\n      }\n    }\n    authorize(headers, requiredRole, successCallback) {\n      const account = this.currentAccount(headers);\n      if (!account) {\n        return this.unauthorized('Missing or invalid authentication token.');\n      }\n      if (requiredRole && account.role !== requiredRole) {\n        return throwError(() => new HttpErrorResponse({\n          status: 403,\n          error: {\n            message: 'Forbidden - Insufficient permissions'\n          }\n        }));\n      }\n      return successCallback();\n    }\n    idFromUrl(url) {\n      const match = url.match(/\\/(\\d+)$/);\n      return match ? parseInt(match[1], 10) : -1;\n    }\n    newAccountId() {\n      return this.accounts.length ? Math.max(0, ...this.accounts.map(x => x.id)) + 1 : 1;\n    }\n    saveAccounts() {\n      localStorage.setItem(accountsKey, JSON.stringify(this.accounts));\n    }\n    generateJwtToken(account) {\n      const payload = {\n        id: account.id,\n        role: account.role,\n        email: account.email,\n        exp: Math.floor(new Date(Date.now() + 15 * 60 * 1000).getTime() / 1000)\n      };\n      const header = btoa(JSON.stringify({\n        alg: 'HS256',\n        typ: 'JWT'\n      }));\n      const encodedPayload = btoa(JSON.stringify(payload));\n      return `${header}.${encodedPayload}.fake-signature-for-demo-only`;\n    }\n    generateRefreshTokenForCookie() {\n      const token = `${Date.now()}-${Math.random().toString(36).substring(2, 12)}`;\n      const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toUTCString();\n      if (typeof document !== 'undefined') {\n        document.cookie = `fakeRefreshToken=${token}; expires=${expires}; path=/; SameSite=Lax`;\n      }\n      return token;\n    }\n    getRefreshTokenFromCookie() {\n      if (typeof document === 'undefined') return undefined;\n      const cookies = document.cookie.split(';');\n      for (let cookie of cookies) {\n        const [name, value] = cookie.trim().split('=');\n        if (name === 'fakeRefreshToken') {\n          return value;\n        }\n      }\n      return undefined;\n    }\n    clearRefreshTokenCookie() {\n      if (typeof document !== 'undefined') {\n        document.cookie = 'fakeRefreshToken=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax';\n      }\n    }\n  }\n  FakeBackendInterceptor.ɵfac = function FakeBackendInterceptor_Factory(t) {\n    return new (t || FakeBackendInterceptor)(i0.ɵɵinject(i1.AlertService));\n  };\n  FakeBackendInterceptor.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: FakeBackendInterceptor,\n    factory: FakeBackendInterceptor.ɵfac\n  });\n  return FakeBackendInterceptor;\n})();\nexport const fakeBackendProvider = {\n  provide: HTTP_INTERCEPTORS,\n  useClass: FakeBackendInterceptor,\n  multi: true\n};","map":{"version":3,"mappings":"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","names":["HttpResponse","HTTP_INTERCEPTORS","HttpErrorResponse","of","throwError","delay","mergeMap","materialize","dematerialize","Role","accountsKey","FakeBackendInterceptor","constructor","alertService","id","employeeId","userId","email","position","departmentId","hireDate","status","name","description","employeeCount","type","details","task","datetimecreated","Date","now","toISOString","requestItems","quantity","employees","length","Math","max","map","e","departments","d","workflows","w","appRequests","r","accounts","JSON","parse","localStorage","getItem","push","title","password","role","Admin","isVerified","refreshTokens","dateCreated","firstName","lastName","User","saveAccounts","intercept","request","next","url","method","headers","body","pipe","handleRoute","endsWith","authenticate","refreshToken","revokeToken","register","verifyEmail","forgotPassword","validateResetToken","resetPassword","getAccounts","match","getAccountById","idFromUrl","createAccount","updateAccount","deleteAccount","authorize","ok","newEmployee","nextEmployeeId","dept","find","employee","error","console","log","stringify","employeeIndex","findIndex","oldEmployeeData","updatedEmployee","targetDepartmentIdFromBody","undefined","parseInt","String","isNaN","oldDept","newDept","deletedEmployee","splice","message","idMatch","oldDepartmentId","newDepartmentId","nextWorkflowId","newDepartment","nextDepartmentId","department","deptIndex","filter","newWorkflow","sortedWorkflows","sort","a","b","dateA","getTime","dateB","currentAcc","currentAccount","unauthorized","userRequests","emp","newRequest","nextAppRequestId","account","x","setTimeout","verifyUrl","location","origin","verificationToken","info","autoClose","generateRefreshTokenForCookie","accountDetails","basicDetails","jwtToken","generateJwtToken","requestRefreshTokenFromBody","requestRefreshTokenFromCookie","getRefreshTokenFromCookie","requestRefreshToken","includes","tokenToRevoke","token","clearRefreshTokenCookie","newAccountData","autoclose","newAccount","newAccountId","random","toString","substring","resetToken","resetTokenExpires","resetUrl","acc","accountIndex","accountToUpdate","updateData","Object","forEach","field","dateUpdated","accountToDelete","authHeader","get","startsWith","payloadB64","split","tokenPayload","atob","exp","warn","requiredRole","successCallback","setItem","payload","floor","header","btoa","alg","typ","encodedPayload","expires","toUTCString","document","cookie","cookies","value","trim","factory","fakeBackendProvider","provide","useClass","multi"],"sourceRoot":"","sources":["E:\\semifinals\\groupB-fullstack-app\\frontend\\src\\app\\_helpers\\fake-backend.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\r\nimport {\r\n    HttpRequest,\r\n    HttpResponse,\r\n    HttpHandler,\r\n    HttpEvent,\r\n    HttpInterceptor,\r\n    HTTP_INTERCEPTORS,\r\n    HttpErrorResponse,\r\n    HttpHeaders\r\n} from '@angular/common/http';\r\nimport { Observable, of, throwError } from 'rxjs';\r\nimport { delay, mergeMap, materialize, dematerialize } from 'rxjs/operators';\r\n\r\nimport { AlertService } from '@app/_services'; // Assuming this path is correct\r\nimport { Role } from '@app/_models';        // Assuming this path is correct\r\n\r\n// --- Interfaces - Combining and refining ---\r\ninterface Account {\r\n    id: number;\r\n    title: string;\r\n    firstName?: string;\r\n    lastName?: string;\r\n    email: string;\r\n    password?: string; // Should be hashed in a real app, stored as-is for fake backend comparison\r\n    role: Role | string;\r\n    employeeId?: number; // Link to an employee\r\n    jwtToken?: string; // For the access token (typically not stored with user, but for response)\r\n    dateCreated?: string;\r\n    dateUpdated?: string;\r\n    isVerified?: boolean;\r\n    verificationToken?: string;\r\n    resetToken?: string;\r\n    resetTokenExpires?: Date | string; // Store as ISO string or Date object\r\n    refreshTokens?: string[]; // Array of active refresh tokens\r\n    status?: 'Active' | 'Inactive' | string;\r\n}\r\n\r\ninterface Employee {\r\n    id: number;\r\n    employeeId: string; // The 'EMP001' style ID\r\n    userId: number; // This should link to Account.id\r\n    email: string; // Optional: If you want to link email to employee\r\n    position: string;\r\n    departmentId: number;\r\n    hireDate: string;\r\n    status: string;\r\n}\r\n\r\ninterface Department {\r\n    id: number;\r\n    name: string;\r\n    description: string;\r\n    employeeCount: number;\r\n}\r\n\r\ninterface Workflow {\r\n    id: number;\r\n    employeeId: number;\r\n    type: string;\r\n    details: any;\r\n    status: string;\r\n    // Optional: Add a creation timestamp if you want to sort by it\r\n    datetimecreated?: string; // Example from a previous context if needed for sorting\r\n}\r\n\r\ninterface AppRequest { // Renamed from 'RequestItem' to avoid conflict with HttpRequest\r\n    id: number;\r\n    employeeId: number;\r\n    type: string;\r\n    requestItems: { name: string; quantity: number }[];\r\n    status: string;\r\n}\r\n\r\n// Key for localStorage\r\nconst accountsKey = 'app-hr-tool-accounts'; // Made key more specific\r\n\r\n@Injectable()\r\nexport class FakeBackendInterceptor implements HttpInterceptor {\r\n    // --- Data Management ---\r\n    private accounts: Account[];\r\n\r\n    // In-memory for other entities\r\n    private employees: Employee[] = [\r\n        { id: 1, employeeId: 'EMP001', userId: 1, email: 'admin@example.com', position: 'Developer', departmentId: 1, hireDate: '2025-01-01', status: 'Active' },\r\n        { id: 2, employeeId: 'EMP002', userId: 2, email: 'user@example.com', position: 'Designer', departmentId: 2, hireDate: '2025-02-01', status: 'Active' }\r\n    ];\r\n    private departments: Department[] = [\r\n        { id: 1, name: 'Engineering', description: 'Software development team', employeeCount: 1 },\r\n        { id: 2, name: 'Marketing', description: 'Marketing team', employeeCount: 1 }\r\n    ];\r\n    private workflows: Workflow[] = [\r\n        { id: 1, employeeId: 1, type: 'Onboarding', details: { task: 'Setup workstation' }, status: 'Pending', datetimecreated: new Date(Date.now() - 100000).toISOString() },\r\n        { id: 2, employeeId: 2, type: 'Offboarding', details: { task: 'Return equipment' }, status: 'Completed', datetimecreated: new Date(Date.now() - 200000).toISOString() }\r\n    ];\r\n    private appRequests: AppRequest[] = [\r\n        { id: 1, employeeId: 2, type: 'Equipment', requestItems: [{ name: 'Laptop', quantity: 1 }], status: 'Pending' }\r\n    ];\r\n\r\n    // ID Generators for in-memory entities\r\n    private nextEmployeeId = this.employees.length > 0 ? Math.max(0, ...this.employees.map(e => e.id)) + 1 : 1;\r\n    private nextDepartmentId = this.departments.length > 0 ? Math.max(0, ...this.departments.map(d => d.id)) + 1 : 1;\r\n    private nextWorkflowId = this.workflows.length > 0 ? Math.max(0, ...this.workflows.map(w => w.id)) + 1 : 1;\r\n    private nextAppRequestId = this.appRequests.length > 0 ? Math.max(0, ...this.appRequests.map(r => r.id)) + 1 : 1;\r\n\r\n    constructor(private alertService: AlertService) {\r\n        this.accounts = JSON.parse(localStorage.getItem(accountsKey)) || [];\r\n        // Ensure default admin/user if local storage is empty or new\r\n        if (this.accounts.length === 0) {\r\n            this.accounts.push({\r\n                id: 1, title: 'Mr', email: 'admin@example.com', password: 'admin', role: Role.Admin, employeeId: 1,\r\n                isVerified: true, status: 'Active', refreshTokens: [], dateCreated: new Date().toISOString(),\r\n                firstName: 'Admin', lastName: 'User'\r\n            });\r\n            this.accounts.push({\r\n                id: 2, title: 'Mr', email: 'user@example.com', password: 'user', role: Role.User, employeeId: 2,\r\n                isVerified: true, status: 'Active', refreshTokens: [], dateCreated: new Date().toISOString(),\r\n                firstName: 'Normal', lastName: 'User'\r\n            });\r\n            this.saveAccounts();\r\n        }\r\n    }\r\n\r\n    intercept(request: HttpRequest<any>, next: HttpHandler): Observable<HttpEvent<any>> {\r\n        const { url, method, headers, body } = request;\r\n\r\n        return of(null)\r\n            .pipe(mergeMap(() => this.handleRoute(url, method, headers as HttpHeaders, body, next)))\r\n            .pipe(materialize())\r\n            .pipe(delay(500))\r\n            .pipe(dematerialize());\r\n    }\r\n\r\n    private handleRoute(url: string, method: string, headers: HttpHeaders, body: any, next: HttpHandler): Observable<HttpEvent<any>> {\r\n        // --- ACCOUNT MANAGEMENT ROUTES ---\r\n        switch (true) {\r\n            case url.endsWith('/accounts/authenticate') && method === 'POST':\r\n                return this.authenticate(body, headers);\r\n            case url.endsWith('/accounts/refresh-token') && method === 'POST':\r\n                return this.refreshToken(body, headers);\r\n            case url.endsWith('/accounts/revoke-token') && method === 'POST':\r\n                return this.revokeToken(body, headers);\r\n            case url.endsWith('/accounts/register') && method === 'POST':\r\n                return this.register(body);\r\n            case url.endsWith('/accounts/verify-email') && method === 'POST':\r\n                return this.verifyEmail(body);\r\n            case url.endsWith('/accounts/forgot-password') && method === 'POST':\r\n                return this.forgotPassword(body);\r\n            case url.endsWith('/accounts/validate-reset-token') && method === 'POST':\r\n                return this.validateResetToken(body);\r\n            case url.endsWith('/accounts/reset-password') && method === 'POST':\r\n                return this.resetPassword(body);\r\n            case url.endsWith('/accounts') && method === 'GET':\r\n                return this.getAccounts(headers);\r\n            case url.match(/\\/accounts\\/(\\d+)$/) && method === 'GET':\r\n                return this.getAccountById(this.idFromUrl(url), headers);\r\n            case url.endsWith('/accounts') && method === 'POST':\r\n                return this.createAccount(body, headers);\r\n            case url.match(/\\/accounts\\/(\\d+)$/) && method === 'PUT':\r\n                return this.updateAccount(this.idFromUrl(url), body, headers);\r\n            case url.match(/\\/accounts\\/(\\d+)$/) && method === 'DELETE':\r\n                return this.deleteAccount(this.idFromUrl(url), headers);\r\n\r\n            // --- OTHER ENTITY ROUTES ---\r\n            // Employees\r\n            case url.endsWith('/employees') && method === 'GET':\r\n                return this.authorize(headers, null, () => this.ok(this.employees));\r\n            case url.endsWith('/employees') && method === 'POST':\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const newEmployee: Employee = { id: this.nextEmployeeId++, ...body };\r\n                    this.employees.push(newEmployee);\r\n                    const dept = this.departments.find(d => d.id === newEmployee.departmentId);\r\n                    if (dept) dept.employeeCount++;\r\n                    return this.ok(newEmployee, 201);\r\n                });\r\n            case url.match(/\\/employees\\/(\\d+)$/) && method === 'GET': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, null, () => {\r\n                    const employee = this.employees.find(e => e.id === id);\r\n                    return employee ? this.ok(employee) : this.error('Employee not found', 404);\r\n                });\r\n            }\r\n            // In FakeBackendInterceptor, within the handleRoute method:\r\n            case url.match(/\\/employees\\/(\\d+)$/) && method === 'PUT': {\r\n                const id = this.idFromUrl(url); // This is the employee's ID (number)\r\n                console.log(`PUT /employees/${id} - Request Body:`, JSON.stringify(body));\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const employeeIndex = this.employees.findIndex(e => e.id === id);\r\n                    if (employeeIndex === -1) return this.error('Employee not found', 404);\r\n\r\n                    const oldEmployeeData = this.employees[employeeIndex];\r\n                    // Create updatedEmployee, ensuring body properties are merged\r\n                    const updatedEmployee = { ...oldEmployeeData, ...body, id };\r\n\r\n                    // Ensure the departmentId from the body is treated as a number for comparison\r\n                    const targetDepartmentIdFromBody = updatedEmployee.departmentId !== undefined && updatedEmployee.departmentId !== null\r\n                        ? parseInt(String(updatedEmployee.departmentId), 10)\r\n                        : undefined;\r\n\r\n                    // Update departmentId on the employee object IF it was provided in the body\r\n                    if (targetDepartmentIdFromBody !== undefined && !isNaN(targetDepartmentIdFromBody)) {\r\n                        updatedEmployee.departmentId = targetDepartmentIdFromBody;\r\n                    }\r\n\r\n\r\n                    if (oldEmployeeData.departmentId !== updatedEmployee.departmentId) {\r\n                        const oldDept = this.departments.find(d => d.id === oldEmployeeData.departmentId);\r\n                        if (oldDept) oldDept.employeeCount = Math.max(0, oldDept.employeeCount - 1);\r\n\r\n                        // Now updatedEmployee.departmentId should be a number if it was valid\r\n                        const newDept = this.departments.find(d => d.id === updatedEmployee.departmentId);\r\n                        if (newDept) {\r\n                            newDept.employeeCount++;\r\n                        } else if (updatedEmployee.departmentId !== oldEmployeeData.departmentId) {\r\n                            // Only error if a new, non-existent departmentId was attempted\r\n                            return this.error(`Target department with id '${updatedEmployee.departmentId}' not found`, 400);\r\n                        }\r\n                    }\r\n\r\n                    this.employees[employeeIndex] = updatedEmployee;\r\n                    return this.ok(this.employees[employeeIndex]);\r\n                });\r\n            }\r\n            case url.match(/\\/employees\\/(\\d+)$/) && method === 'DELETE': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const employeeIndex = this.employees.findIndex(e => e.id === id);\r\n                    if (employeeIndex === -1) return this.error('Employee not found', 404);\r\n                    const deletedEmployee = this.employees.splice(employeeIndex, 1)[0];\r\n                    if (deletedEmployee) {\r\n                        const dept = this.departments.find(d => d.id === deletedEmployee.departmentId);\r\n                        if (dept) dept.employeeCount = Math.max(0, dept.employeeCount - 1);\r\n                    }\r\n                    return this.ok({ message: 'Employee deleted' });\r\n                });\r\n            }\r\n            case url.match(/\\/employees\\/(\\d+)\\/transfer$/) && method === 'POST': {\r\n                const idMatch = url.match(/\\/employees\\/(\\d+)\\/transfer$/);\r\n                if (!idMatch) return this.error('Invalid URL for employee transfer', 400);\r\n                const id = parseInt(idMatch[1]);\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const employee = this.employees.find(e => e.id === id);\r\n                    if (!employee) return this.error('Employee not found', 404);\r\n                    const oldDepartmentId = employee.departmentId;\r\n                    const newDepartmentId = body.departmentId;\r\n                    if (oldDepartmentId !== newDepartmentId) {\r\n                        const oldDept = this.departments.find(d => d.id === oldDepartmentId);\r\n                        if (oldDept) oldDept.employeeCount = Math.max(0, oldDept.employeeCount - 1);\r\n                        const newDept = this.departments.find(d => d.id === newDepartmentId);\r\n                        if (newDept) newDept.employeeCount++;\r\n                        else return this.error('Target department not found', 400);\r\n                    }\r\n                    employee.departmentId = newDepartmentId;\r\n                    this.workflows.push({\r\n                        id: this.nextWorkflowId++, employeeId: id, type: 'Transfer',\r\n                        details: body, status: 'Pending', datetimecreated: new Date().toISOString()\r\n                    });\r\n                    return this.ok({ message: 'Employee transferred successfully', employee });\r\n                });\r\n            }\r\n\r\n            // Departments\r\n            case url.endsWith('/departments') && method === 'GET':\r\n                return this.authorize(headers, null, () => this.ok(this.departments));\r\n            case url.endsWith('/departments') && method === 'POST':\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const newDepartment: Department = { id: this.nextDepartmentId++, ...body, employeeCount: 0 };\r\n                    this.departments.push(newDepartment);\r\n                    return this.ok(newDepartment, 201);\r\n                });\r\n\r\n            case url.match(/\\/departments\\/(\\d+)$/) && method === 'GET': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, null, () => { // Or specific role if needed\r\n                    const department = this.departments.find(d => d.id === id);\r\n                    return department ? this.ok(department) : this.error(`Department with id ${id} not found`, 404);\r\n                });\r\n            }\r\n            case url.match(/\\/departments\\/(\\d+)$/) && method === 'PUT': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const deptIndex = this.departments.findIndex(d => d.id === id);\r\n                    if (deptIndex === -1) return this.error('Department not found', 404);\r\n                    this.departments[deptIndex] = { ...this.departments[deptIndex], ...body, id };\r\n                    return this.ok(this.departments[deptIndex]);\r\n                });\r\n            }\r\n            case url.match(/\\/departments\\/(\\d+)$/) && method === 'DELETE': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const dept = this.departments.find(d => d.id === id);\r\n                    if (!dept) return this.error('Department not found', 404);\r\n                    if (dept.employeeCount > 0) return this.error('Cannot delete department with active employees.', 400);\r\n                    this.departments = this.departments.filter(d => d.id !== id);\r\n                    return this.ok({ message: 'Department deleted' });\r\n                });\r\n            }\r\n\r\n\r\n            // Workflows\r\n            case url.match(/\\/workflows\\/employee\\/(\\d+)$/) && method === 'GET': {\r\n                const idMatch = url.match(/\\/workflows\\/employee\\/(\\d+)$/);\r\n                if (!idMatch) return this.error('Invalid URL for employee workflows', 400);\r\n                const employeeId = parseInt(idMatch[1]);\r\n                return this.authorize(headers, null, () => {\r\n                    const workflows = this.workflows.filter(w => w.employeeId === employeeId);\r\n                    return this.ok(workflows);\r\n                });\r\n            }\r\n            case url.endsWith('/workflows') && method === 'POST':\r\n                return this.authorize(headers, Role.Admin, () => {\r\n                    const newWorkflow: Workflow = {\r\n                        id: this.nextWorkflowId++,\r\n                        ...body,\r\n                        datetimecreated: new Date().toISOString() // Add timestamp on creation\r\n                    };\r\n                    this.workflows.push(newWorkflow);\r\n                    return this.ok(newWorkflow, 201);\r\n                });\r\n            // *** ADDED HANDLER FOR GET /workflows ***\r\n            case url.endsWith('/workflows') && method === 'GET':\r\n                return this.authorize(headers, Role.Admin, () => { // Or null if all users can see all workflows\r\n                    // Optional: sort workflows if not already handled by client or a specific query param\r\n                    const sortedWorkflows = [...this.workflows].sort((a, b) => {\r\n                        const dateA = new Date(a.datetimecreated || 0).getTime();\r\n                        const dateB = new Date(b.datetimecreated || 0).getTime();\r\n                        return dateB - dateA; // Descending\r\n                    });\r\n                    return this.ok(sortedWorkflows);\r\n                });\r\n\r\n            // AppRequests\r\n            case url.endsWith('/requests') && method === 'GET':\r\n                return this.authorize(headers, null, () => {\r\n                    const currentAcc = this.currentAccount(headers);\r\n                    if (!currentAcc) return this.unauthorized();\r\n                    if (currentAcc.role === Role.Admin) return this.ok(this.appRequests);\r\n\r\n                    const userRequests = this.appRequests.filter(r => {\r\n                        const emp = this.employees.find(e => e.id === r.employeeId);\r\n                        return emp && emp.userId === currentAcc.id;\r\n                    });\r\n                    return this.ok(userRequests);\r\n                });\r\n            case url.endsWith('/requests') && method === 'POST':\r\n                return this.authorize(headers, null, () => {\r\n                    const currentAcc = this.currentAccount(headers);\r\n                    if (!currentAcc || !currentAcc.employeeId) return this.error(\"User not linked to an employee or not authenticated.\", 400);\r\n\r\n                    const newRequest: AppRequest = { id: this.nextAppRequestId++, employeeId: currentAcc.employeeId, ...body, status: 'Pending' };\r\n                    this.appRequests.push(newRequest);\r\n                    return this.ok(newRequest, 201);\r\n                });\r\n            case url.match(/\\/requests\\/(\\d+)$/) && method === 'GET': {\r\n                const id = this.idFromUrl(url);\r\n                return this.authorize(headers, null, () => { // Allow user to get their own, admin to get any\r\n                    const currentAcc = this.currentAccount(headers);\r\n                    if (!currentAcc) return this.unauthorized();\r\n\r\n                    const request = this.appRequests.find(r => r.id === id);\r\n                    if (!request) {\r\n                        return this.error(`Request with id ${id} not found`, 404);\r\n                    }\r\n\r\n                    // Authorization check: Admin can see any, user can only see their own\r\n                    if (currentAcc.role !== Role.Admin) {\r\n                        const employee = this.employees.find(e => e.id === request.employeeId);\r\n                        if (!employee || employee.userId !== currentAcc.id) {\r\n                            return this.unauthorized(\"You are not authorized to view this request.\");\r\n                        }\r\n                    }\r\n                    return this.ok(request);\r\n                });\r\n            }\r\n\r\n\r\n            default:\r\n                // return next.handle(request); // If you have a real backend\r\n                return throwError(() => new HttpErrorResponse({\r\n                    status: 404, error: { message: `Fake backend: Route not found for ${method} ${url}` }\r\n                }));\r\n        }\r\n    }\r\n\r\n    // --- ACCOUNT MANAGEMENT METHODS ---\r\n    private authenticate(body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const { email, password } = body;\r\n        const account = this.accounts.find(x => x.email === email);\r\n\r\n        if (!account) return this.error('Email does not exist', 400);\r\n        if (!account.isVerified) {\r\n            setTimeout(() => {\r\n                const verifyUrl = `${location.origin}/account/verify-email?token=${account.verificationToken}`;\r\n                this.alertService.info(`<h4>Verification Email</h4><p>Please click the link to verify: <a href=\"${verifyUrl}\">${verifyUrl}</a></p>`, { autoClose: false });\r\n            }, 1000);\r\n            return this.error('Email is not yet verified.', 400);\r\n        }\r\n        if (account.password !== password) return this.error('Incorrect password.', 400);\r\n        if (account.status !== 'Active') return this.error('Account is inactive. Please contact support.', 400);\r\n\r\n        account.refreshTokens = account.refreshTokens || [];\r\n        account.refreshTokens.push(this.generateRefreshTokenForCookie());\r\n        this.saveAccounts();\r\n\r\n        const accountDetails = this.basicDetails(account);\r\n        return this.ok({\r\n            ...accountDetails,\r\n            jwtToken: this.generateJwtToken(account)\r\n        });\r\n    }\r\n\r\n    private refreshToken(body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const requestRefreshTokenFromBody = body.refreshToken;\r\n        const requestRefreshTokenFromCookie = this.getRefreshTokenFromCookie();\r\n        const requestRefreshToken = requestRefreshTokenFromBody || requestRefreshTokenFromCookie;\r\n\r\n\r\n        if (!requestRefreshToken) return this.unauthorized('Refresh token missing.');\r\n\r\n        const account = this.accounts.find(x => x.refreshTokens && x.refreshTokens.includes(requestRefreshToken));\r\n        if (!account) return this.unauthorized('Invalid or expired refresh token.');\r\n\r\n        account.refreshTokens = account.refreshTokens.filter(x => x !== requestRefreshToken);\r\n        account.refreshTokens.push(this.generateRefreshTokenForCookie());\r\n        this.saveAccounts();\r\n\r\n        return this.ok({\r\n            ...this.basicDetails(account),\r\n            jwtToken: this.generateJwtToken(account)\r\n        });\r\n    }\r\n\r\n    private revokeToken(body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const currentAcc = this.currentAccount(headers);\r\n        if (!currentAcc) return this.unauthorized();\r\n\r\n        const tokenToRevoke = body.token || this.getRefreshTokenFromCookie();\r\n        const account = this.accounts.find(x => x.id === currentAcc.id);\r\n\r\n        if (account && account.refreshTokens && tokenToRevoke) {\r\n            account.refreshTokens = account.refreshTokens.filter(x => x !== tokenToRevoke);\r\n            this.saveAccounts();\r\n        }\r\n        if (tokenToRevoke && tokenToRevoke === this.getRefreshTokenFromCookie()) {\r\n            this.clearRefreshTokenCookie();\r\n        }\r\n        return this.ok({ message: 'Token revoked successfully.' });\r\n    }\r\n\r\n    private register(body: any): Observable<HttpEvent<any>> {\r\n        const newAccountData = body as Partial<Account>;\r\n\r\n        if (!newAccountData.email || !newAccountData.password) {\r\n            return this.error('Email and password are required.', 400);\r\n        }\r\n        if (this.accounts.find(x => x.email === newAccountData.email)) {\r\n            setTimeout(() => {\r\n                this.alertService.info(`\r\n                        <h4>Email Already Registered</h4>\r\n                        <p>Your email ${newAccountData.email} is already registered.</p>\r\n                        <p>If you don't know your password please visit the <a href=\"${location.origin}/account/forgot-password\">forgot password</a> page.</p>\r\n                        <div>\r\n                        <strong>NOTE:</strong> The fake backend displayed this \"email\" so you can test without an API. A real backend would send a real email.\r\n                        </div>\r\n                    `, { autoclose: false });\r\n            }, 1000);\r\n            return this.error(`Email '${newAccountData.email}' is already registered.`, 400);\r\n        }\r\n\r\n        const newAccount: Account = {\r\n            id: this.newAccountId(),\r\n            email: newAccountData.email,\r\n            password: newAccountData.password,\r\n            role: this.accounts.length === 0 ? Role.Admin : Role.User,\r\n            firstName: newAccountData.firstName || '',\r\n            lastName: newAccountData.lastName || '',\r\n            title: newAccountData.title || '',\r\n            status: this.accounts.length === 0 ? 'Active' : 'Inactive',\r\n            dateCreated: new Date().toISOString(),\r\n            verificationToken: `${Date.now()}-${Math.random().toString(36).substring(2, 10)}`,\r\n            isVerified: this.accounts.length === 0,\r\n            refreshTokens: []\r\n        };\r\n\r\n        this.accounts.push(newAccount);\r\n        this.saveAccounts();\r\n\r\n        if (!newAccount.isVerified) {\r\n            setTimeout(() => {\r\n                const verifyUrl = `${location.origin}/account/verify-email?token=${newAccount.verificationToken}`;\r\n                this.alertService.info(`<h4>Verification Email</h4><p>Thanks for registering! Please click the link to verify your email: <a href=\"${verifyUrl}\">${verifyUrl}</a></p><div><strong>NOTE:</strong> This is a fake email.</div>`, { autoClose: false });\r\n            }, 1000);\r\n        }\r\n        return this.ok({ message: 'Registration successful. Please check your email to verify your account if required.' }, 201);\r\n    }\r\n\r\n    private verifyEmail(body: any): Observable<HttpEvent<any>> {\r\n        const { token } = body;\r\n        if (!token) return this.error('Verification token is required.', 400);\r\n\r\n        const account = this.accounts.find(x => x.verificationToken === token);\r\n        if (!account) return this.error('Verification failed.', 400);\r\n        if (account.isVerified) return this.ok({ message: 'Email already verified.' });\r\n\r\n\r\n        account.isVerified = true;\r\n        account.status = 'Active';\r\n        delete account.verificationToken;\r\n        this.saveAccounts();\r\n        return this.ok({ message: 'Email verified successfully. You can now login.' });\r\n    }\r\n\r\n    private forgotPassword(body: any): Observable<HttpEvent<any>> {\r\n        const { email } = body;\r\n        if (!email) return this.error('Email is required.', 400);\r\n\r\n        const account = this.accounts.find(x => x.email === email);\r\n        if (account) {\r\n            account.resetToken = `${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;\r\n            account.resetTokenExpires = new Date(Date.now() + 24 * 60 * 60 * 1000);\r\n            this.saveAccounts();\r\n            setTimeout(() => {\r\n                const resetUrl = `${location.origin}/account/reset-password?token=${account.resetToken}`;\r\n                this.alertService.info(`<h4>Reset Password Email</h4><p>Please click the link to reset your password: <a href=\"${resetUrl}\">${resetUrl}</a></p><p>The link will be valid for 24 hours.</p><div><strong>NOTE:</strong> This is a fake email.</div>`, { autoClose: false });\r\n            }, 1000);\r\n        }\r\n        return this.ok({ message: 'If your email address is registered, you will receive a password reset link.' });\r\n    }\r\n\r\n    private validateResetToken(body: any): Observable<HttpEvent<any>> {\r\n        const { token } = body;\r\n        if (!token) return this.error('Reset token is required.', 400);\r\n        const account = this.accounts.find(x => x.resetToken === token && x.resetTokenExpires && new Date(x.resetTokenExpires) > new Date());\r\n        return account ? this.ok({ message: 'Token is valid.' }) : this.error('Invalid or expired reset token.', 400);\r\n    }\r\n\r\n    private resetPassword(body: any): Observable<HttpEvent<any>> {\r\n        const { token, password } = body;\r\n        if (!token || !password) return this.error('Token and new password are required.', 400);\r\n\r\n        const account = this.accounts.find(x => x.resetToken === token && x.resetTokenExpires && new Date(x.resetTokenExpires) > new Date());\r\n        if (!account) return this.error('Invalid or expired reset token.', 400);\r\n\r\n        account.password = password;\r\n        account.isVerified = true;\r\n        account.status = 'Active';\r\n        delete account.resetToken;\r\n        delete account.resetTokenExpires;\r\n        this.saveAccounts();\r\n        return this.ok({ message: 'Password has been reset successfully. You can now login.' });\r\n    }\r\n\r\n    private getAccounts(headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        return this.authorize(headers, Role.Admin, () => {\r\n            return this.ok(this.accounts.map(acc => this.basicDetails(acc)));\r\n        });\r\n    }\r\n\r\n    private getAccountById(id: number, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const currentAcc = this.currentAccount(headers);\r\n        if (!currentAcc) return this.unauthorized();\r\n\r\n        const account = this.accounts.find(x => x.id === id);\r\n        if (!account) return this.error('Account not found', 404);\r\n\r\n        if (currentAcc.role !== Role.Admin && currentAcc.id !== account.id) {\r\n            return this.unauthorized(\"You are not authorized to view this account.\");\r\n        }\r\n        return this.ok(this.basicDetails(account));\r\n    }\r\n\r\n    private createAccount(body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        return this.authorize(headers, Role.Admin, () => {\r\n            const newAccountData = body as Partial<Account>;\r\n            if (!newAccountData.email || !newAccountData.password || !newAccountData.role) {\r\n                return this.error('Email, password, and role are required for new account creation.', 400);\r\n            }\r\n            if (this.accounts.find(x => x.email === newAccountData.email)) {\r\n                return this.error(`Email '${newAccountData.email}' is already registered`, 400);\r\n            }\r\n            const newAccount: Account = {\r\n                id: this.newAccountId(),\r\n                email: newAccountData.email,\r\n                password: newAccountData.password,\r\n                role: newAccountData.role,\r\n                firstName: newAccountData.firstName || '',\r\n                lastName: newAccountData.lastName || '',\r\n                title: newAccountData.title || '',\r\n                dateCreated: new Date().toISOString(),\r\n                isVerified: true,\r\n                status: 'Active',\r\n                refreshTokens: [],\r\n                employeeId: newAccountData.employeeId\r\n            };\r\n            this.accounts.push(newAccount);\r\n            this.saveAccounts();\r\n            return this.ok(this.basicDetails(newAccount), 201);\r\n        });\r\n    }\r\n\r\n    private updateAccount(id: number, body: any, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const currentAcc = this.currentAccount(headers);\r\n        if (!currentAcc) return this.unauthorized();\r\n\r\n        const accountIndex = this.accounts.findIndex(x => x.id === id);\r\n        if (accountIndex === -1) return this.error('Account not found', 404);\r\n        const accountToUpdate = this.accounts[accountIndex];\r\n\r\n        if (currentAcc.role !== Role.Admin && currentAcc.id !== accountToUpdate.id) {\r\n            return this.unauthorized(\"You are not authorized to update this account.\");\r\n        }\r\n\r\n        const updateData = { ...body } as Partial<Account>;\r\n        if (currentAcc.id === accountToUpdate.id && currentAcc.role !== Role.Admin && updateData.role && updateData.role !== accountToUpdate.role) {\r\n            return this.error(\"You cannot change your own role.\", 403);\r\n        }\r\n\r\n        if (updateData.password) {\r\n            accountToUpdate.password = updateData.password;\r\n        }\r\n        ['firstName', 'lastName', 'title', 'email', 'role', 'status', 'employeeId'].forEach(field => {\r\n            if (updateData[field] !== undefined) {\r\n                accountToUpdate[field] = updateData[field];\r\n            }\r\n        });\r\n\r\n        accountToUpdate.dateUpdated = new Date().toISOString();\r\n        this.accounts[accountIndex] = accountToUpdate;\r\n        this.saveAccounts();\r\n        return this.ok(this.basicDetails(accountToUpdate));\r\n    }\r\n\r\n    private deleteAccount(id: number, headers: HttpHeaders): Observable<HttpEvent<any>> {\r\n        const currentAcc = this.currentAccount(headers);\r\n        if (!currentAcc) return this.unauthorized();\r\n\r\n        const accountIndex = this.accounts.findIndex(x => x.id === id);\r\n        if (accountIndex === -1) return this.error('Account not found', 404);\r\n\r\n        const accountToDelete = this.accounts[accountIndex];\r\n        if (currentAcc.role !== Role.Admin && currentAcc.id !== accountToDelete.id) {\r\n            return this.unauthorized(\"You are not authorized to delete this account.\");\r\n        }\r\n        if (accountToDelete.id === currentAcc.id && accountToDelete.role === Role.Admin && this.accounts.filter(a => a.role === Role.Admin).length <= 1) {\r\n            return this.error(\"Cannot delete the last admin account.\", 400);\r\n        }\r\n\r\n        this.accounts.splice(accountIndex, 1);\r\n        this.saveAccounts();\r\n        if (accountToDelete.id === currentAcc.id) {\r\n            this.clearRefreshTokenCookie();\r\n        }\r\n        return this.ok({ message: 'Account deleted successfully.' });\r\n    }\r\n\r\n    // --- HELPER METHODS ---\r\n    private ok(body?: any, status = 200): Observable<HttpResponse<any>> {\r\n        return of(new HttpResponse({ status, body }));\r\n    }\r\n\r\n    private error(message: string, status = 400): Observable<HttpEvent<never>> {\r\n        return throwError(() => new HttpErrorResponse({ error: { message }, status }));\r\n    }\r\n\r\n    private unauthorized(message = 'Unauthorized'): Observable<HttpEvent<never>> {\r\n        return throwError(() => new HttpErrorResponse({ status: 401, error: { message } }));\r\n    }\r\n\r\n    private basicDetails(account: Account): Partial<Account> {\r\n        const { id, title, firstName, lastName, email, role, dateCreated, dateUpdated, isVerified, status, employeeId } = account;\r\n        return { id, title, firstName, lastName, email, role, dateCreated, dateUpdated, isVerified, status, employeeId };\r\n    }\r\n\r\n    private currentAccount(headers: HttpHeaders): Account | undefined {\r\n        const authHeader = headers.get('Authorization');\r\n        if (!authHeader || !authHeader.startsWith('Bearer ')) return undefined;\r\n\r\n        const token = authHeader.substring(7);\r\n        try {\r\n            const payloadB64 = token.split('.')[1];\r\n            if (!payloadB64) return undefined;\r\n\r\n            const tokenPayload = JSON.parse(atob(payloadB64));\r\n            if (Date.now() >= tokenPayload.exp * 1000) {\r\n                console.warn(\"Fake backend: JWT token expired\");\r\n                this.clearRefreshTokenCookie();\r\n                return undefined;\r\n            }\r\n            return this.accounts.find(x => x.id === tokenPayload.id);\r\n        } catch (e) {\r\n            console.error(\"Fake backend: Error parsing JWT token\", e);\r\n            return undefined;\r\n        }\r\n    }\r\n\r\n    private authorize(headers: HttpHeaders, requiredRole: Role | string | null, successCallback: () => Observable<HttpEvent<any>>): Observable<HttpEvent<any>> {\r\n        const account = this.currentAccount(headers);\r\n        if (!account) {\r\n            return this.unauthorized('Missing or invalid authentication token.');\r\n        }\r\n        if (requiredRole && account.role !== requiredRole) {\r\n            return throwError(() => new HttpErrorResponse({ status: 403, error: { message: 'Forbidden - Insufficient permissions' } }));\r\n        }\r\n        return successCallback();\r\n    }\r\n\r\n    private idFromUrl(url: string): number {\r\n        const match = url.match(/\\/(\\d+)$/);\r\n        return match ? parseInt(match[1], 10) : -1;\r\n    }\r\n\r\n    private newAccountId(): number {\r\n        return this.accounts.length ? Math.max(0, ...this.accounts.map(x => x.id)) + 1 : 1;\r\n    }\r\n\r\n    private saveAccounts(): void {\r\n        localStorage.setItem(accountsKey, JSON.stringify(this.accounts));\r\n    }\r\n\r\n    private generateJwtToken(account: Account): string {\r\n        const payload = {\r\n            id: account.id,\r\n            role: account.role,\r\n            email: account.email,\r\n            exp: Math.floor(new Date(Date.now() + 15 * 60 * 1000).getTime() / 1000),\r\n        };\r\n        const header = btoa(JSON.stringify({ alg: 'HS256', typ: 'JWT' }));\r\n        const encodedPayload = btoa(JSON.stringify(payload));\r\n        return `${header}.${encodedPayload}.fake-signature-for-demo-only`;\r\n    }\r\n\r\n    private generateRefreshTokenForCookie(): string {\r\n        const token = `${Date.now()}-${Math.random().toString(36).substring(2, 12)}`;\r\n        const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toUTCString();\r\n        if (typeof document !== 'undefined') {\r\n            document.cookie = `fakeRefreshToken=${token}; expires=${expires}; path=/; SameSite=Lax`;\r\n        }\r\n        return token;\r\n    }\r\n\r\n    private getRefreshTokenFromCookie(): string | undefined {\r\n        if (typeof document === 'undefined') return undefined;\r\n        const cookies = document.cookie.split(';');\r\n        for (let cookie of cookies) {\r\n            const [name, value] = cookie.trim().split('=');\r\n            if (name === 'fakeRefreshToken') {\r\n                return value;\r\n            }\r\n        }\r\n        return undefined;\r\n    }\r\n\r\n    private clearRefreshTokenCookie(): void {\r\n        if (typeof document !== 'undefined') {\r\n            document.cookie = 'fakeRefreshToken=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/; SameSite=Lax';\r\n        }\r\n    }\r\n}\r\n\r\nexport const fakeBackendProvider = {\r\n    provide: HTTP_INTERCEPTORS,\r\n    useClass: FakeBackendInterceptor,\r\n    multi: true\r\n};"]},"metadata":{},"sourceType":"module","externalDependencies":[]}